<div class="dashboard-main-body">
  <app-breadcrumb [title]="title"></app-breadcrumb>

  <!-- Filters -->
  <div class="fee-card mb-24">
    <div class="fee-card-header">
      <div class="header-left">
        <h4 style="margin: 0; font-size: 16px; font-weight: 700; color: #1e293b;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            style="width: 18px; height: 18px; margin-right: 6px; vertical-align: text-bottom;">
            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" />
          </svg>
          Result Filters
        </h4>
      </div>
    </div>
    <div class="fee-card-body p-24">
      <div class="row gy-4">
        <div class="col-md-3">
          <label class="field-label">Select Exam <span class="text-danger">*</span></label>
          <select class="field-input" [(ngModel)]="selectedExamId" name="exam">
            <option [ngValue]="0" disabled selected hidden>Select Exam</option>
            <option *ngFor="let exam of exams" [ngValue]="exam.examId">{{ exam.examName }}</option>
          </select>
        </div>

        <div class="col-md-3">
          <label class="field-label">Select Class (Required)</label>
          <select class="field-input" [(ngModel)]="selectedClassId" (change)="onClassChange()" name="class">
            <option [ngValue]="0">All Classes</option>
            <option *ngFor="let cls of classes" [ngValue]="cls.standardId">{{ formatStandardName(cls.standardName) }}
            </option>
          </select>
        </div>

        <div class="col-md-3">
          <label class="field-label">Select Section (Optional)</label>
          <select class="field-input" [(ngModel)]="selectedSectionId" (change)="onSectionChange()" name="section">
            <option [ngValue]="0">All Sections</option>
            <option *ngFor="let sec of sections" [ngValue]="sec.sectionId">{{ sec.sectionName }}</option>
          </select>
        </div>

        <div class="col-md-3">
          <label class="field-label">Select Student <span class="text-danger">*</span></label>
          <select class="field-input" [(ngModel)]="selectedStudentId" name="student">
            <option [ngValue]="0" disabled selected hidden>Select Student</option>
            <option *ngFor="let student of filteredStudents" [ngValue]="student.studentId">
              {{ student.admissionNo }} - {{ student.studentName }}
            </option>
          </select>
          <small class="text-secondary" *ngIf="selectedClassId > 0 && filteredStudents.length === 0"
            style="display: block; margin-top: 6px;">No students found in this class.</small>
        </div>

        <div class="col-12 text-end mt-16">
          <button class="btn-primary-gradient" (click)="loadResults()"
            [disabled]="!selectedExamId || !selectedStudentId">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
              style="width: 18px; height: 18px;">
              <circle cx="11" cy="11" r="8" />
              <line x1="21" y1="21" x2="16.65" y2="16.65" />
            </svg>
            View Result
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-3 text-secondary-light fw-medium">Analyzing student performance...</p>
  </div>

  <!-- Empty State -->
  <div *ngIf="!loading && examResults.length === 0" class="fee-card mb-24">
    <div class="fee-card-body p-80 text-center">
      <div class="empty-state">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
          <polyline points="14 2 14 8 20 8" />
          <line x1="16" y1="13" x2="8" y2="13" />
          <line x1="16" y1="17" x2="8" y2="17" />
          <polyline points="10 9 9 9 8 9" />
        </svg>
        <h5 style="margin: 16px 0 8px; color: #1e293b; font-weight: 700;">No Result Loaded</h5>
        <p style="margin: 0 auto; max-width: 400px; color: #64748b;">Please use the filters above to select an exam and
          a student to view their detailed performance report.</p>
      </div>
    </div>
  </div>

  <!-- Results Component -->
  <div *ngIf="!loading && examResults.length > 0">

    <!-- Action Menu -->
    <div class="d-flex justify-content-end gap-3 mb-24">
      <button type="button" (click)="printResult()" class="btn-ghost" style="padding: 10px 20px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          style="width: 18px; height: 18px; margin-right: 8px;">
          <polyline points="6 9 6 2 18 2 18 9" />
          <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" />
          <rect x="6" y="14" width="12" height="8" />
        </svg>
        Print Result
      </button>
      <button type="button" (click)="printResult()" class="btn-primary-gradient"
        style="background: linear-gradient(135deg, #10b981, #059669); box-shadow: 0 4px 14px rgba(16, 185, 129, 0.3);">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
          style="width: 18px; height: 18px; margin-right: 8px;">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
          <polyline points="7 10 12 15 17 10" />
          <line x1="12" y1="15" x2="12" y2="3" />
        </svg>
        Download PDF
      </button>
    </div>

    <!-- Summary Stats -->
    <div class="stats-row mb-24">
      <div class="stat-card">
        <div class="stat-icon-wrapper blue">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
            <line x1="3" y1="9" x2="21" y2="9" />
            <line x1="9" y1="21" x2="9" y2="9" />
          </svg>
        </div>
        <div class="stat-content">
          <span class="stat-label">Total Max Marks</span>
          <h3 class="stat-value">{{ totalMarks }}</h3>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon-wrapper indigo">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />
          </svg>
        </div>
        <div class="stat-content">
          <span class="stat-label">Obtained Marks</span>
          <h3 class="stat-value">{{ obtainedMarks }}</h3>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon-wrapper green">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21.21 15.89A10 10 0 1 1 8 2.83" />
            <path d="M22 12A10 10 0 0 0 12 2v10z" />
          </svg>
        </div>
        <div class="stat-content">
          <span class="stat-label">Avg Percentage</span>
          <h3 class="stat-value">{{ percentage | number:'1.1-1' }}%</h3>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon-wrapper"
          [ngStyle]="{'background': resultStatus === 'PASS' ? '#dcfce7' : '#fee2e2', 'color': resultStatus === 'PASS' ? '#16a34a' : '#ef4444'}">
          <svg *ngIf="resultStatus === 'PASS'" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="8" r="7" />
            <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88" />
          </svg>
          <svg *ngIf="resultStatus === 'FAIL'" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10" />
            <line x1="12" y1="8" x2="12" y2="12" />
            <line x1="12" y1="16" x2="12.01" y2="16" />
          </svg>
        </div>
        <div class="stat-content">
          <span class="stat-label">Final Status</span>
          <h3 class="stat-value">
            <span class="amount-chip" [ngClass]="resultStatus === 'PASS' ? 'paid' : 'unpaid'"
              style="font-size: 16px; padding: 6px 12px;">
              {{ resultStatus }}
            </span>
          </h3>
        </div>
      </div>
    </div>

    <!-- Details Table -->
    <div class="fee-card">
      <div class="fee-card-header">
        <div class="header-left">
          <h4 style="margin: 0; font-size: 16px; font-weight: 700; color: #1e293b;">Detailed Subject Report</h4>
        </div>
        <div>
          <span class="amount-chip partial" style="padding: 6px 14px;">Academic Results 2025</span>
        </div>
      </div>

      <div class="fee-card-body">
        <div class="table-wrapper">
          <table class="fee-table">
            <thead>
              <tr>
                <th style="padding-left: 24px;">Subject Name</th>
                <th class="text-center">Total Marks</th>
                <th class="text-center">Obtained</th>
                <th class="text-center" style="width: 25%;">Percentage</th>
                <th class="text-center">Grade</th>
                <th class="text-center" style="padding-right: 24px;">Status</th>
              </tr>
            </thead>
            <tbody>
              <tr class="table-row" *ngFor="let result of displayResults">
                <td style="padding-left: 24px;">
                  <span class="amount-val">{{ result.subjectName }}</span>
                </td>
                <td class="text-center">
                  <span style="color: #64748b; font-weight: 600;">{{ result.totalMarks }}</span>
                </td>
                <td class="text-center">
                  <span class="amount-val" style="color: #0284c7;">{{ result.obtainedMarks }}</span>
                </td>
                <td>
                  <div class="d-flex align-items-center justify-content-center gap-2">
                    <div class="progress w-100"
                      style="max-width: 100px; height: 6px; background-color: #f1f5f9; border-radius: 12px; overflow: hidden;">
                      <div class="progress-bar" role="progressbar" [style.width.%]="result.percentage"
                        [ngStyle]="{'background': result.isPassed ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, #ef4444, #dc2626)'}">
                      </div>
                    </div>
                    <span style="font-size: 13px; font-weight: 600; color: #475569;">{{ result.percentage }}%</span>
                  </div>
                </td>
                <td class="text-center">
                  <span class="badge" [ngStyle]="{
                    'border': '1px solid',
                    'background': result.grade === 'A+' || result.grade === 'A' ? '#dcfce7' : (result.grade === 'B' ? '#e0f2fe' : (result.grade === 'F' ? '#fee2e2' : '#fef9c3')),
                    'color': result.grade === 'A+' || result.grade === 'A' ? '#16a34a' : (result.grade === 'B' ? '#0284c7' : (result.grade === 'F' ? '#ef4444' : '#ca8a04')),
                    'border-color': result.grade === 'A+' || result.grade === 'A' ? '#bbf7d0' : (result.grade === 'B' ? '#bae6fd' : (result.grade === 'F' ? '#fecaca' : '#fef08a')),
                    'padding': '6px 12px',
                    'border-radius': '8px',
                    'font-weight': '600'
                  }">
                    {{ result.grade }}
                  </span>
                </td>
                <td class="text-center" style="padding-right: 24px;">
                  <span class="amount-chip" [ngClass]="result.isPassed ? 'paid' : 'unpaid'">
                    <iconify-icon
                      [icon]="result.isPassed ? 'solar:check-circle-bold-duotone' : 'solar:close-circle-bold-duotone'"
                      style="margin-right: 4px; vertical-align: text-bottom;"></iconify-icon>
                    {{ result.isPassed ? 'Passed' : 'Failed' }}
                  </span>
                </td>
              </tr>
            </tbody>
            <tfoot style="background: #f8fafc; border-top: 2px solid #e2e8f0;">
              <tr>
                <td style="padding-left: 24px; padding-top: 20px; padding-bottom: 20px;">
                  <span
                    style="font-weight: 700; color: #0284c7; letter-spacing: 0.5px; text-transform: uppercase; font-size: 13px;">Aggregate
                    Result</span>
                </td>
                <td class="text-center" style="padding-top: 20px; padding-bottom: 20px;">
                  <span style="font-weight: 700; color: #1e293b;">{{ totalMarks }}</span>
                </td>
                <td class="text-center" style="padding-top: 20px; padding-bottom: 20px;">
                  <span style="font-weight: 800; color: #0284c7; font-size: 18px;">{{ obtainedMarks }}</span>
                </td>
                <td class="text-center" style="padding-top: 20px; padding-bottom: 20px;">
                  <span style="font-weight: 700; color: #1e293b;">{{ percentage | number:'1.2-2' }}%</span>
                </td>
                <td class="text-center" style="padding-top: 20px; padding-bottom: 20px;">
                  <span class="badge"
                    style="background: #1e293b; color: #fff; padding: 6px 16px; border-radius: 8px; font-weight: 700; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">{{
                    overallGrade }}</span>
                </td>
                <td class="text-center" style="padding-right: 24px; padding-top: 20px; padding-bottom: 20px;">
                  <span class="amount-chip" [ngClass]="resultStatus === 'PASS' ? 'paid' : 'unpaid'"
                    style="font-size: 14px; padding: 8px 16px;">
                    {{ resultStatus }}
                  </span>
                </td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
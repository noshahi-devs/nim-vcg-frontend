<div class="dashboard-main-body">
  <app-breadcrumb [title]="title"></app-breadcrumb>

  <!-- Premium Stats Cards -->
  <div class="row gy-4 mb-30 mt-2">
    <div class="col-xxl-3 col-sm-6">
      <div class="stat-card-premium">
        <div class="icon-wrapper-premium" style="background: rgba(128, 0, 32, 0.1); color: #800020;">
          <iconify-icon icon="solar:document-text-bold-duotone"></iconify-icon>
        </div>
        <span class="text-secondary-light fw-bold text-uppercase letter-spacing-1 small">Total Requests</span>
        <h2 class="fw-black mb-0 mt-8" style="color: #800020;">{{ totalLeaves }}</h2>
      </div>
    </div>

    <div class="col-xxl-3 col-sm-6">
      <div class="stat-card-premium">
        <div class="icon-wrapper-premium" style="background: rgba(245, 158, 11, 0.1); color: #d97706;">
          <iconify-icon icon="solar:clock-circle-bold-duotone"></iconify-icon>
        </div>
        <span class="text-secondary-light fw-bold text-uppercase letter-spacing-1 small">Pending Approval</span>
        <h2 class="fw-black mb-0 mt-8" style="color: #d97706;">{{ pendingLeaves }}</h2>
      </div>
    </div>

    <div class="col-xxl-3 col-sm-6">
      <div class="stat-card-premium">
        <div class="icon-wrapper-premium" style="background: rgba(34, 197, 94, 0.1); color: #16a34a;">
          <iconify-icon icon="solar:check-circle-bold-duotone"></iconify-icon>
        </div>
        <span class="text-secondary-light fw-bold text-uppercase letter-spacing-1 small">Approved Leaves</span>
        <h2 class="fw-black mb-0 mt-8" style="color: #16a34a;">{{ approvedLeaves }}</h2>
      </div>
    </div>

    <div class="col-xxl-3 col-sm-6">
      <div class="stat-card-premium">
        <div class="icon-wrapper-premium" style="background: rgba(239, 68, 68, 0.1); color: #dc2626;">
          <iconify-icon icon="solar:close-circle-bold-duotone"></iconify-icon>
        </div>
        <span class="text-secondary-light fw-bold text-uppercase letter-spacing-1 small">Rejected / Denied</span>
        <h2 class="fw-black mb-0 mt-8" style="color: #dc2626;">{{ rejectedLeaves }}</h2>
      </div>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="filter-container-premium">
    <div class="row align-items-end g-4">
      <div class="col-md-5">
        <label class="form-label-premium ms-2 mb-10"><iconify-icon icon="solar:filter-linear"
            class="me-8"></iconify-icon>Current Status</label>
        <select class="form-select input-premium" [(ngModel)]="statusFilter" (change)="applyFilters()">
          <option value="All">All Status Manifests</option>
          <option value="Pending">Pending Review</option>
          <option value="Approved">Verified & Approved</option>
          <option value="Rejected">Rejected Applications</option>
        </select>
      </div>
      <div class="col-md-5">
        <label class="form-label-premium ms-2 mb-10"><iconify-icon icon="solar:settings-linear"
            class="me-8"></iconify-icon>Leave Category</label>
        <select class="form-select input-premium" [(ngModel)]="leaveTypeFilter" (change)="applyFilters()">
          <option value="All">All Leave Categories</option>
          <option *ngFor="let type of leaveTypes" [value]="type">{{ type }}</option>
        </select>
      </div>
      <div class="col-md-2 text-end">
        <button type="button" (click)="refreshData()" class="btn btn-outline-dark radius-16 w-100 py-12 fw-bold">
          <iconify-icon icon="solar:refresh-linear" class="me-8"></iconify-icon>Reload
        </button>
      </div>
    </div>
  </div>

  <!-- Main Table Card -->
  <div class="table-card-premium">
    <div class="table-header-premium">
      <div>
        <h6>Employee Leave Management</h6>
        <p class="mb-0 text-white-50 small fw-medium">Real-time processing of staff attendance manifests</p>
      </div>
      <div class="d-flex gap-3">
        <button type="button" (click)="exportData()" class="btn btn-light radius-12 fw-bold px-20">
          <iconify-icon icon="solar:export-bold" class="me-8"></iconify-icon>Export Ledger
        </button>
      </div>
    </div>

    <div class="p-0">
      <div class="table-responsive">
        <table class="table premium-table">
          <thead>
            <tr>
              <th><span class="ps-10">S.L</span></th>
              <th>Applicant Identity</th>
              <th>Category</th>
              <th>Cycle Period</th>
              <th class="text-center">Quotas</th>
              <th>Request Context</th>
              <th class="text-center">Status</th>
              <th class="text-center">Review</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let leave of paginatedLeaves; let i = index">
              <td><span class="ps-10 fw-bold text-secondary-light">{{ (currentPage - 1) * rowsPerPage + i + 1 }}</span>
              </td>
              <td>
                <div class="d-flex align-items-center">
                  <div class="avatar-badge-premium me-15">
                    {{ (leave.staff?.staffName || '?').charAt(0) }}
                  </div>
                  <div>
                    <span class="fw-bold text-dark d-block">{{ leave.staff?.staffName || 'N/A' }}</span>
                    <small class="text-secondary-light fw-medium">{{ leave.staff?.designation || 'Staff' }}</small>
                  </div>
                </div>
              </td>
              <td>
                <span class="badge radius-8 px-12 py-6 fw-bold"
                  style="background: rgba(128, 0, 32, 0.05); color: #800020;">
                  {{ getLeaveTypeName(leave.leaveType) }}
                </span>
              </td>
              <td>
                <div class="d-flex flex-column">
                  <span class="fw-bold text-dark small">{{ leave.startDate | date:'dd MMM' }} - {{ leave.endDate |
                    date:'dd MMM yyyy' }}</span>
                </div>
              </td>
              <td class="text-center">
                <span class="fw-black text-primary-600 h5 mb-0">{{ getDurationDays(leave.startDate, leave.endDate)
                  }}</span>
                <small class="d-block text-muted fw-bold" style="font-size: 0.65rem;">DAYS</small>
              </td>
              <td>
                <span class="text-secondary-light small" [title]="leave.reason">
                  {{ leave.reason.length > 35 ? leave.reason.substring(0, 35) + '...' : leave.reason }}
                </span>
              </td>
              <td class="text-center">
                <span class="status-indicator" [ngClass]="{
                  'status-pending': leave.status === 0,
                  'status-approved': leave.status === 1,
                  'status-rejected': leave.status === 2
                }">
                  <iconify-icon
                    [icon]="leave.status === 0 ? 'solar:clock-circle-linear' : (leave.status === 1 ? 'solar:check-circle-linear' : 'solar:close-circle-linear')"></iconify-icon>
                  {{ getLeaveStatusName(leave.status) }}
                </span>
              </td>
              <td class="text-center">
                <div class="d-flex align-items-center justify-content-center"
                  *ngIf="leave.status === 0 && hasRole('Principal')">
                  <button type="button" (click)="openApproveModal(leave)" class="decision-btn btn-approve"
                    title="Authorize Request">
                    <iconify-icon icon="solar:check-read-bold" class="text-xl"></iconify-icon>
                  </button>
                  <button type="button" (click)="openRejectModal(leave)" class="decision-btn btn-reject"
                    title="Deny Request">
                    <iconify-icon icon="solar:close-square-bold" class="text-xl"></iconify-icon>
                  </button>
                </div>
                <iconify-icon *ngIf="leave.status !== 0" icon="solar:verified-check-bold-duotone"
                  class="text-xxl text-primary-100"></iconify-icon>
              </td>
            </tr>
            <tr *ngIf="paginatedLeaves.length === 0 && !loading">
              <td colspan="8" class="text-center py-80">
                <iconify-icon icon="solar:sleeping-linear" class="text-primary-100"
                  style="font-size: 6rem;"></iconify-icon>
                <h4 class="mt-20 text-secondary-light fw-bold">All Quiet Here</h4>
                <p class="text-muted">No pending leave requests found for the current selection</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Premium Pagination -->
      <div class="d-flex align-items-center justify-content-between p-30 border-top mt-0"
        *ngIf="filteredLeaves.length > 0">
        <span class="text-secondary-light fw-bold small text-uppercase letter-spacing-1">
          Showing entries <span class="text-dark">{{ (currentPage - 1) * rowsPerPage + 1 }} - {{ Math.min(currentPage *
            rowsPerPage, filteredLeaves.length) }}</span> of {{ filteredLeaves.length }}
        </span>
        <nav>
          <ul class="pagination mb-0 gap-2">
            <li class="page-item" [class.disabled]="currentPage === 1">
              <a class="page-link radius-14 border-0 shadow-sm transition-all py-10 px-16"
                (click)="changePage(currentPage - 1)" href="javascript:void(0)">
                <iconify-icon icon="solar:alt-arrow-left-linear"></iconify-icon>
              </a>
            </li>
            <li class="page-item" *ngFor="let page of [].constructor(totalPages); let i = index">
              <a class="page-link radius-14 border-0 shadow-sm transition-all py-10 px-18 fw-bold"
                [style.background]="currentPage === i + 1 ? '#800020' : 'white'"
                [style.color]="currentPage === i + 1 ? 'white' : '#64748b'" (click)="changePage(i + 1)"
                href="javascript:void(0)">
                {{ i + 1 }}
              </a>
            </li>
            <li class="page-item" [class.disabled]="currentPage === totalPages">
              <a class="page-link radius-14 border-0 shadow-sm transition-all py-10 px-16"
                (click)="changePage(currentPage + 1)" href="javascript:void(0)">
                <iconify-icon icon="solar:alt-arrow-right-linear"></iconify-icon>
              </a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>

<!-- Decision Modal -->
<div class="modal fade" [class.show]="showModal" [style.display]="showModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content modal-glass-content">
      <div class="modal-header border-0 p-30 pb-0">
        <div>
          <h3 class="fw-black mb-5" [style.color]="modalAction === 'approve' ? '#16a34a' : '#dc2626'">
            {{ modalAction === 'approve' ? 'Authorize' : 'Decline' }} Manifest
          </h3>
          <p class="text-secondary-light mb-0 small uppercase fw-black letter-spacing-1">Final Review Processor</p>
        </div>
        <button type="button" class="btn-close" (click)="closeModal()"></button>
      </div>

      <div class="modal-body p-30" *ngIf="selectedLeave">
        <div class="detail-strip-premium mb-25">
          <div class="row align-items-center">
            <div class="col-auto">
              <div class="avatar-badge-premium" style="width: 60px; height: 60px; font-size: 1.5rem;">
                {{ (selectedLeave.staff?.staffName || '?').charAt(0) }}
              </div>
            </div>
            <div class="col">
              <h5 class="fw-bold mb-2">{{ selectedLeave.staff?.staffName }}</h5>
              <span class="badge bg-white text-dark border radius-6 fw-bold">{{
                getLeaveTypeName(selectedLeave.leaveType) }}</span>
            </div>
            <div class="col-auto text-end">
              <h3 class="fw-black text-primary-600 mb-0">{{ getDurationDays(selectedLeave.startDate,
                selectedLeave.endDate) }}</h3>
              <small class="fw-black text-muted letter-spacing-1">DAYS</small>
            </div>
          </div>
          <hr class="my-15 opacity-10">
          <p class="mb-0 small fw-medium text-dark italic">"{{ selectedLeave.reason }}"</p>
        </div>

        <div class="mb-30">
          <label class="form-label-premium ms-2 mb-10">Administrative Remarks</label>
          <textarea class="form-control input-premium" [(ngModel)]="remarks" name="remarks" rows="4"
            [placeholder]="'Provide reasoning for ' + (modalAction === 'approve' ? 'approval' : 'rejection') + '...'"
            required></textarea>
        </div>

        <div class="d-flex gap-3">
          <button type="button" (click)="closeModal()"
            class="btn btn-light radius-16 w-100 py-15 fw-bold text-muted">CANCEL</button>
          <button type="button" (click)="confirmAction()" class="decision-btn-final w-100"
            [style.background]="modalAction === 'approve' ? '#16a34a' : '#dc2626'" [style.color]="'white'"
            [style.boxShadow]="modalAction === 'approve' ? '0 10px 25px rgba(22, 163, 74, 0.3)' : '0 10px 25px rgba(220, 38, 38, 0.3)'">
            {{ modalAction === 'approve' ? 'APPROVE REQUEST' : 'REJECT REQUEST' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Backdrop -->
<div class="modal-backdrop fade" [class.show]="showModal" *ngIf="showModal" (click)="closeModal()"></div>
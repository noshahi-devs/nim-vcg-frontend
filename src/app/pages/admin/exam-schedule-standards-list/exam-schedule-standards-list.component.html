<div class="dashboard-main-body">
  <app-breadcrumb [title]="title"></app-breadcrumb>

  <!-- ===================== STATS CARDS ===================== -->
  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-icon-wrapper blue">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
          <line x1="16" y1="2" x2="16" y2="6" />
          <line x1="8" y1="2" x2="8" y2="6" />
          <line x1="3" y1="10" x2="21" y2="10" />
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-label">Total Exam Schedules</span>
        <h3 class="stat-value">{{ list.length }}</h3>
      </div>
    </div>
  </div>

  <!-- ===================== TABLE CARD ===================== -->
  <div class="fee-card">
    <div class="fee-card-header">
      <div class="header-left">
        <div class="show-entries">
          <span>Show</span>
          <select class="entries-select" [(ngModel)]="rowsPerPage" (change)="currentPage=1;updatePagination()">
            <option [value]="10">10</option>
            <option [value]="25">25</option>
            <option [value]="50">50</option>
          </select>
          <span>entries</span>
        </div>
        <div class="search-wrapper">
          <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8" />
            <path d="M21 21l-4.35-4.35" />
          </svg>
          <input class="search-input" [(ngModel)]="searchTerm" (input)="search()"
            placeholder="Search Exam / Standard" />
        </div>
      </div>
      <div class="d-flex align-items-center gap-2">
        <button class="btn-ghost" style="padding: 9px 18px; color: #64748b; font-weight: 600; font-size: 13.5px;"
          (click)="loadData()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
            style="width: 16px; height: 16px; margin-right: 6px; vertical-align: middle;">
            <path d="M21.5 2v6h-6M21.34 15.57a10 10 0 1 1-.92-10.44l5.67-5.67" />
          </svg>
          Refresh
        </button>
        <button class="btn-add" routerLink="/exam-schedule-standards-create">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <path d="M12 5v14M5 12h14" />
          </svg>
          Add Exam Schedule
        </button>
      </div>
    </div>

    <!-- TABLE AREA -->
    <div class="fee-card-body">
      <div *ngIf="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>

      <div *ngIf="!loading" class="table-wrapper">
        <table class="fee-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Exam Schedule</th>
              <th>Standard</th>
              <th class="text-center">Subjects Count</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr class="table-row" *ngFor="let item of paginatedList; let i = index">
              <td><span class="row-num">{{ (currentPage-1)*rowsPerPage + i + 1 }}</span></td>
              <td>
                <span class="amount-val">{{ item.examScheduleName }}</span>
              </td>
              <td>
                <span class="enrollment-badge">{{ item.standardName }}</span>
              </td>
              <td class="text-center">
                <span class="amount-chip paid">{{ item.examSubjects?.length || 0 }}</span>
              </td>
              <td class="text-center">
                <div class="action-group">
                  <button class="icon-btn view-btn" (click)="openViewModal(item)" title="View Details">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                      <circle cx="12" cy="12" r="3" />
                    </svg>
                  </button>
                  <button class="icon-btn edit-btn" (click)="openEditModal(item)" title="Edit">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                      <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                    </svg>
                  </button>
                  <!-- The updated delete logic handles this inline instead of calling SweetAlert directly from the component -->
                  <button class="icon-btn delete-btn"
                    (click)="confirmDelete(item.examScheduleStandardId, item.examScheduleName)" title="Delete">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="3 6 5 6 21 6" />
                      <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6" />
                      <path d="M10 11v6M14 11v6" />
                      <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1-1v2" />
                    </svg>
                  </button>
                </div>
              </td>
            </tr>

            <tr *ngIf="paginatedList.length === 0">
              <td colspan="5" class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                  <line x1="16" y1="2" x2="16" y2="6" />
                  <line x1="8" y1="2" x2="8" y2="6" />
                  <line x1="3" y1="10" x2="21" y2="10" />
                </svg>
                <p>No schedule standards found</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- PAGINATION -->
      <div *ngIf="!loading && filteredList.length > 0" class="pagination-bar">
        <span class="pagination-info">Showing {{ (currentPage-1)*rowsPerPage + 1 }} to {{
          Math.min(currentPage*rowsPerPage, filteredList.length) }} of {{ filteredList.length }} entries</span>
        <div class="pagination-controls">
          <button class="page-btn" [disabled]="currentPage === 1" (click)="changePage(currentPage - 1)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15 18 9 12 15 6" />
            </svg>
          </button>
          <ng-container *ngFor="let p of [].constructor(totalPages); let i = index">
            <button class="page-btn" [class.active]="currentPage === i + 1" (click)="changePage(i + 1)">{{ i+1
              }}</button>
          </ng-container>
          <button class="page-btn" [disabled]="currentPage === totalPages" (click)="changePage(currentPage + 1)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 18 15 12 9 6" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===================== VIEW MODAL ===================== -->
<div *ngIf="showViewDialog && selectedItem" class="modal-overlay" (click)="closeDialog()">
  <div class="modal-box" (click)="$event.stopPropagation()" style="max-width: 800px;">
    <div class="modal-header">
      <div class="modal-icon view-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
          <circle cx="12" cy="12" r="3" />
        </svg>
      </div>
      <div>
        <h4 class="modal-title">Exam Schedule Details</h4>
        <p class="modal-subtitle">Viewing details of {{ selectedItem.examScheduleName }}</p>
      </div>
      <button class="modal-close" (click)="closeDialog()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6 6 18M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="modal-body-premium">
      <div class="form-row-2">
        <div class="form-card">
          <div class="form-card-label">
            <span class="card-dot blue"></span>
            Schedule Setup
          </div>
          <div class="form-group-premium">
            <label class="field-label">Exam Schedule</label>
            <div class="amount-val fw-600">{{ selectedItem.examScheduleName }}</div>
          </div>
        </div>
        <div class="form-card">
          <div class="form-card-label">
            <span class="card-dot indigo"></span>
            Associated Standard
          </div>
          <div class="form-group-premium">
            <label class="field-label">Standard Name</label>
            <div class="amount-val">{{ selectedItem.standardName }}</div>
          </div>
        </div>
      </div>

      <div class="form-card mt-24">
        <div class="form-card-label">
          <span class="card-dot green"></span>
          Subject Dates & Times
        </div>
        <div class="table-wrapper" style="margin-top: 10px; max-height: 300px; overflow-y: auto;">
          <table class="fee-table">
            <thead>
              <tr>
                <th>Subject</th>
                <th>Exam Type</th>
                <th>Date</th>
                <th>Timing</th>
              </tr>
            </thead>
            <tbody>
              <tr class="table-row" *ngFor="let s of selectedItem.examSubjects">
                <td><span class="amount-val">{{ s.subjectName }}</span></td>
                <td><span class="enrollment-badge">{{ s.examTypeName }}</span></td>
                <td>{{ s.examDate | date:'mediumDate' }}</td>
                <td><span style="color: #64748b; font-size: 13px;">{{ s.examStartTime }} - {{ s.examEndTime }}</span>
                </td>
              </tr>
              <tr *ngIf="!selectedItem.examSubjects || selectedItem.examSubjects.length === 0">
                <td colspan="4" class="empty-state" style="padding: 20px;">
                  <p>No subjects found</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-save" style="background: linear-gradient(135deg,#0ea5e9,#0284c7)" (click)="closeDialog()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <path d="M18 6 6 18M6 6l12 12" />
        </svg>
        Close
      </button>
    </div>
  </div>
</div>

<!-- ===================== EDIT MODAL ===================== -->
<div *ngIf="showEditDialog && editModel" class="modal-overlay" (click)="closeDialog()">
  <div class="modal-box" (click)="$event.stopPropagation()" style="max-width: 800px;">

    <!-- Gradient Header -->
    <div class="modal-header-premium">
      <div class="header-gradient" style="background: linear-gradient(135deg, #10b981, #059669);"></div>
      <div class="header-content">
        <div class="modal-icon-premium edit-mode">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
          </svg>
        </div>
        <div>
          <h4 class="modal-title-premium" style="color: #059669;">Update Exam Dates</h4>
          <p class="modal-subtitle-premium">Updating subjects for {{ editModel?.examScheduleName }} ({{
            editModel?.standardName }})</p>
        </div>
      </div>
      <button class="modal-close-premium" (click)="closeDialog()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <path d="M18 6 6 18M6 6l12 12" />
        </svg>
      </button>
    </div>

    <!-- Modal Body -->
    <div class="modal-body-premium">
      <div class="form-card">
        <div class="form-card-label">
          <span class="card-dot green"></span>
          Subject Times Configuration
        </div>
        <div class="table-wrapper" style="margin-top: 10px; max-height: 400px; overflow-y: auto;">
          <table class="fee-table">
            <thead>
              <tr>
                <th>Subject</th>
                <th>Date</th>
                <th>Start Time</th>
                <th>End Time</th>
              </tr>
            </thead>
            <tbody>
              <tr class="table-row" *ngFor="let s of editModel?.examSubjects">
                <td><span class="amount-val">{{ s.subjectName }}</span></td>
                <td><input type="date" [(ngModel)]="s.examDate" class="field-input accent-green"
                    style="padding: 6px 12px;"></td>
                <td><input type="time" [(ngModel)]="s.examStartTime" class="field-input accent-green"
                    style="padding: 6px 12px;"></td>
                <td><input type="time" [(ngModel)]="s.examEndTime" class="field-input accent-green"
                    style="padding: 6px 12px;"></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="modal-footer-premium">
      <button class="btn-ghost" (click)="closeDialog()">Cancel</button>
      <button class="btn-primary-gradient"
        style="background: linear-gradient(135deg, #10b981, #059669); box-shadow: 0 4px 14px rgba(16, 185, 129, 0.3);"
        (click)="update()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <polyline points="20 6 9 17 4 12" />
        </svg>
        Update All Dates
      </button>
    </div>

  </div>
</div>

<!-- ===================== DELETE MODAL ===================== -->
<div *ngIf="showDeleteDialog" class="modal-overlay" (click)="closeDialog()">
  <div class="modal-box delete-box" (click)="$event.stopPropagation()">
    <div class="delete-icon-wrapper">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
        <line x1="12" y1="9" x2="12" y2="13" />
        <line x1="12" y1="17" x2="12.01" y2="17" />
      </svg>
    </div>
    <h3 class="delete-title">Confirm Delete</h3>
    <p class="delete-message">
      Are you sure you want to delete the schedule standard for "<strong>{{ itemToDeleteName }}</strong>"? This action
      cannot be undone.
    </p>
    <div class="delete-actions">
      <button class="btn-ghost" (click)="closeDialog()">Cancel</button>
      <button class="btn-danger-gradient" (click)="executeDelete()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <polyline points="3 6 5 6 21 6" />
          <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6" />
          <path d="M10 11v6M14 11v6" />
        </svg>
        Delete
      </button>
    </div>
  </div>
</div>
<div class="dashboard-main-body">
  <app-breadcrumb [title]="title"></app-breadcrumb>

  <!-- Summary Stats -->
  <div class="stats-row animate-fade-up" *ngIf="authService.hasAnyRole(['Admin', 'Principal', 'Accountant'])">
    <div class="stat-card">
      <div class="stat-icon-wrapper blue">
        <iconify-icon icon="solar:folder-bold-duotone"></iconify-icon>
      </div>
      <div class="stat-content">
        <span class="stat-label">Total Classes</span>
        <h5 class="stat-value">{{ classes.length }}</h5>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon-wrapper green">
        <iconify-icon icon="solar:users-group-two-rounded-bold-duotone"></iconify-icon>
      </div>
      <div class="stat-content">
        <span class="stat-label">Total Students</span>
        <h5 class="stat-value">{{ totalStudents }}</h5>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon-wrapper orange">
        <iconify-icon icon="solar:book-bold-duotone"></iconify-icon>
      </div>
      <div class="stat-content">
        <span class="stat-label">Total Subjects</span>
        <h5 class="stat-value">{{ totalSubjects }}</h5>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon-wrapper yellow">
        <iconify-icon icon="solar:layers-bold-duotone"></iconify-icon>
      </div>
      <div class="stat-content">
        <span class="stat-label">Total Sections</span>
        <h5 class="stat-value">{{ totalSections }}</h5>
      </div>
    </div>
  </div>

  <!-- Main Table Card -->
  <div class="fee-card animate-fade-up delay-100">
    <div class="fee-card-header">
      <div class="header-left">
        <h6 class="header-title-premium">
          <iconify-icon icon="solar:folder-bold-duotone"></iconify-icon>
          Management Portal
        </h6>
      </div>

      <div class="header-actions">
        <!-- Search -->
        <div class="search-wrapper">
          <iconify-icon icon="ion:search-outline" class="search-icon"></iconify-icon>
          <input type="text" class="search-input" [(ngModel)]="searchTerm" (input)="applyFilter()" name="search"
            placeholder="Search class, teacher, code..." />
        </div>

        <!-- Entries select -->
        <select class="entries-select" [(ngModel)]="rowsPerPage" (change)="currentPage = 1; updatePagination()">
          <option [value]="10">10 Rows</option>
          <option [value]="25">25 Rows</option>
          <option [value]="50">50 Rows</option>
        </select>

        <!-- Refresh -->
        <button type="button" (click)="loadData()" class="btn-refresh" title="Reload Data">
          <iconify-icon icon="mdi:refresh"></iconify-icon>
          Refresh
        </button>

        <!-- Add Button -->
        <a routerLink="/newclass" class="btn-add" *ngIf="authService.hasRole('Admin')">
          <iconify-icon icon="ic:baseline-plus"></iconify-icon>
          New Class
        </a>
      </div>
    </div>

    <div class="fee-card-body">
      <!-- Loading State -->
      <div *ngIf="loading" class="text-center py-40">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="text-secondary-light mt-12">Synchronizing data...</p>
      </div>

      <!-- No Data State -->
      <div *ngIf="!loading && paginatedClasses.length === 0" class="empty-state">
        <iconify-icon icon="solar:folder-error-bold-duotone"></iconify-icon>
        <p>No class records discovered matching your criteria.</p>
        <a routerLink="/newclass" class="btn-add mt-16" *ngIf="authService.hasRole('Admin')">Initialize First Class</a>
      </div>

      <!-- Premium Table -->
      <div class="fee-table-wrapper" *ngIf="!loading && paginatedClasses.length > 0">
        <table class="fee-table">
          <thead>
            <tr>
              <th style="width: 60px;">ID</th>
              <th>Class Identity</th>
              <th>Assigned Teacher</th>
              <th class="text-center">Subjects</th>
              <th class="text-center">Sections</th>
              <th class="text-center">Students</th>
              <th class="text-center">Status</th>
              <th class="text-center">Operations</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let cls of paginatedClasses; let i = index">
              <td>
                <span class="row-num">{{ (currentPage - 1) * rowsPerPage + i + 1 }}</span>
              </td>
              <td>
                <div class="class-info-wrap">
                  <div class="class-icon">
                    <iconify-icon icon="solar:folder-bold-duotone"></iconify-icon>
                  </div>
                  <div>
                    <span class="class-name">{{ cls.standardName }}</span>
                    <span class="class-code">{{ cls.standardCode || 'No Code' }}</span>
                  </div>
                </div>
              </td>
              <td>
                <div class="teacher-tag">
                  <iconify-icon icon="solar:user-bold-duotone"></iconify-icon>
                  <span>{{ cls.classTeacher || 'Unassigned' }}</span>
                </div>
              </td>
              <td class="text-center">
                <span class="badge-premium badge-blue">
                  {{ cls.subjects?.length || 0 }} Dept.
                </span>
              </td>
              <td class="text-center">
                <span class="badge-premium badge-orange">
                  {{ getSectionsForClass(cls).length }} Units
                </span>
              </td>
              <td class="text-center">
                <span class="badge-premium badge-green">
                  {{ cls.students?.length || 0 }} Enroll.
                </span>
              </td>
              <td class="text-center">
                <span class="badge-premium" [ngClass]="cls.status === 'Inactive' ? 'badge-red' : 'badge-green'">
                  {{ cls.status || 'Active' }}
                </span>
              </td>
              <td>
                <div class="action-btns">
                  <button type="button" (click)="openViewDialog(cls)" class="icon-btn btn-view" title="Explore Class">
                    <iconify-icon icon="mdi:eye-outline"></iconify-icon>
                  </button>
                  <a [routerLink]="['/subject-add']" [queryParams]="{ classId: cls.standardId }"
                    class="icon-btn btn-subject" title="Manage Subjects"
                    *ngIf="authService.hasAnyRole(['Admin', 'Principal'])">
                    <iconify-icon icon="solar:book-bold-duotone"></iconify-icon>
                  </a>
                  <a [routerLink]="['/student-add']" [queryParams]="{ classId: cls.standardId }"
                    class="icon-btn btn-student" title="Add Students"
                    *ngIf="authService.hasAnyRole(['Admin', 'Principal'])">
                    <iconify-icon icon="solar:user-plus-bold-duotone"></iconify-icon>
                  </a>
                  <a [routerLink]="['/section-add']" [queryParams]="{ className: cls.standardName }"
                    class="icon-btn btn-section" title="Configure Sections"
                    *ngIf="authService.hasAnyRole(['Admin', 'Principal'])">
                    <iconify-icon icon="solar:layers-bold-duotone"></iconify-icon>
                  </a>
                  <button type="button" (click)="deleteClass(cls)" class="icon-btn btn-delete" title="Archive Record"
                    *ngIf="authService.hasRole('Admin')">
                    <iconify-icon icon="fluent:delete-24-regular"></iconify-icon>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Premium Pagination -->
      <div class="pagination-wrap" *ngIf="!loading && filteredClasses.length > 0">
        <span class="pagination-info">
          Displaying {{ (currentPage - 1) * rowsPerPage + 1 }} -
          {{ Math.min(currentPage * rowsPerPage, filteredClasses.length) }}
          of {{ filteredClasses.length }}
        </span>

        <div class="pagination-btns">
          <div class="page-link-premium" [class.disabled]="currentPage === 1" (click)="changePage(currentPage - 1)">
            <iconify-icon icon="ep:arrow-left"></iconify-icon>
          </div>

          <div *ngFor="let page of getPageNumbers()" class="page-link-premium" [class.active]="currentPage === page"
            (click)="changePage(page)">
            {{ page }}
          </div>

          <div class="page-link-premium" [class.disabled]="currentPage === totalPages"
            (click)="changePage(currentPage + 1)">
            <iconify-icon icon="ep:arrow-right"></iconify-icon>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- PREMIUM DETAIL MODAL -->
<div class="modal-overlay" *ngIf="showViewDialog" (click)="closeDialog()">
  <div class="modal-box" (click)="$event.stopPropagation()">
    <div class="modal-header-premium">
      <div class="modal-icon-premium">
        <iconify-icon icon="solar:folder-bold-duotone"></iconify-icon>
      </div>
      <div class="modal-header-text">
        <h3>{{ selectedClass?.standardName }}</h3>
        <p>Class Identification: {{ selectedClass?.standardCode || 'N/A' }}</p>
      </div>
      <button class="btn-close-premium" (click)="closeDialog()">
        <iconify-icon icon="material-symbols:close-rounded"></iconify-icon>
      </button>
    </div>

    <div class="modal-body-premium" *ngIf="selectedClass">
      <!-- Quick Stats -->
      <div class="info-cards-grid">
        <div class="info-stat-card blue">
          <span class="info-stat-val">{{ selectedClass.subjects?.length || 0 }}</span>
          <span class="info-stat-lab">Subjects</span>
        </div>
        <div class="info-stat-card orange">
          <span class="info-stat-val">{{ getSectionsForClass(selectedClass).length }}</span>
          <span class="info-stat-lab">Sections</span>
        </div>
        <div class="info-stat-card green">
          <span class="info-stat-val">{{ selectedClass.students?.length || 0 }}</span>
          <span class="info-stat-lab">Students</span>
        </div>
      </div>

      <!-- Teacher Detail -->
      <div class="detail-section">
        <span class="detail-label">
          <iconify-icon icon="solar:user-bold-duotone"></iconify-icon>
          Supervising Teacher
        </span>
        <div class="d-flex align-items-center gap-3">
          <div class="fw-bold text-dark fs-5">{{ selectedClass.classTeacher || 'No Teacher Assigned' }}</div>
          <span class="badge-premium badge-green ms-auto">{{ selectedClass.status || 'Active' }}</span>
        </div>
      </div>

      <!-- Subjects Tag Cloud -->
      <div class="detail-section">
        <span class="detail-label">
          <iconify-icon icon="solar:book-bold-duotone"></iconify-icon>
          Curriculum Subjects
        </span>
        <div class="detail-tags" *ngIf="selectedClass.subjects && selectedClass.subjects.length > 0">
          <span class="tag-premium" *ngFor="let s of selectedClass.subjects">
            {{ s.subjectName }}
          </span>
        </div>
        <p class="text-muted text-sm" *ngIf="!selectedClass.subjects || selectedClass.subjects.length === 0">
          No subjects mapped to this curriculum.
        </p>
      </div>

      <!-- Sections Tag Cloud -->
      <div class="detail-section" *ngIf="getSectionsForClass(selectedClass).length > 0">
        <span class="detail-label">
          <iconify-icon icon="solar:layers-bold-duotone"></iconify-icon>
          Registered Sections
        </span>
        <div class="detail-tags">
          <span class="tag-premium" *ngFor="let sec of getSectionsForClass(selectedClass)">
            {{ sec.sectionName }}
            <small class="text-muted" *ngIf="sec.classTeacher">({{ sec.classTeacher.staffName }})</small>
          </span>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-modal-close" (click)="closeDialog()">Acknowledge</button>
    </div>
  </div>
</div>
<div class="dashboard-main-body">
  <app-breadcrumb [title]="title"></app-breadcrumb>

  <!-- ══════ Stats ══════ -->
  <div class="stats-row">
    <div class="stat-card-glass">
      <div class="stat-icon-circle primary">
        <iconify-icon icon="solar:document-text-bold-duotone"></iconify-icon>
      </div>
      <div>
        <div class="stat-label">Total Requests</div>
        <div class="stat-value">{{ totalLeaves }}</div>
      </div>
    </div>
    <div class="stat-card-glass">
      <div class="stat-icon-circle warning">
        <iconify-icon icon="solar:clock-circle-bold-duotone"></iconify-icon>
      </div>
      <div>
        <div class="stat-label">Pending Approval</div>
        <div class="stat-value text-warning">{{ pendingLeaves }}</div>
      </div>
    </div>
    <div class="stat-card-glass">
      <div class="stat-icon-circle success">
        <iconify-icon icon="solar:check-circle-bold-duotone"></iconify-icon>
      </div>
      <div>
        <div class="stat-label">Approved</div>
        <div class="stat-value text-success">{{ approvedLeaves }}</div>
      </div>
    </div>
    <div class="stat-card-glass">
      <div class="stat-icon-circle danger">
        <iconify-icon icon="solar:close-circle-bold-duotone"></iconify-icon>
      </div>
      <div>
        <div class="stat-label">Rejected</div>
        <div class="stat-value text-danger">{{ rejectedLeaves }}</div>
      </div>
    </div>
  </div>

  <!-- ══════ Filters ══════ -->
  <div class="filter-glass">
    <div class="row align-items-end g-3">
      <div class="col-md-5">
        <label class="form-label">Current Status</label>
        <select class="field-select" [(ngModel)]="statusFilter" (change)="applyFilters()">
          <option value="All">All Statuses</option>
          <option value="Pending">Pending Review</option>
          <option value="Approved">Approved</option>
          <option value="Rejected">Rejected</option>
        </select>
      </div>
      <div class="col-md-5">
        <label class="form-label">Leave Category</label>
        <select class="field-select" [(ngModel)]="leaveTypeFilter" (change)="applyFilters()">
          <option value="All">All Categories</option>
          <option *ngFor="let type of leaveTypes" [value]="type">{{ type }}</option>
        </select>
      </div>
      <div class="col-md-2">
        <button type="button" (click)="refreshData()" class="btn-refresh-glass w-100">
          <iconify-icon icon="solar:refresh-linear"></iconify-icon> Reload
        </button>
      </div>
    </div>
  </div>

  <!-- ══════ Table ══════ -->
  <div class="table-glass-container">
    <div class="table-glass-header">
      <div>
        <h5>Employee Leave Management</h5>
        <p>Real-time processing of staff leave requests</p>
      </div>
      <button type="button" (click)="exportData()" class="btn-export">
        <iconify-icon icon="solar:export-bold"></iconify-icon> Export
      </button>
    </div>

    <div class="table-responsive">
      <table class="premium-table">
        <thead>
          <tr>
            <th class="ps-4">S.L</th>
            <th>Applicant</th>
            <th>Category</th>
            <th>Period</th>
            <th class="text-center">Days</th>
            <th>Reason</th>
            <th class="text-center">Status</th>
            <th class="text-center">Review</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let leave of paginatedLeaves; let i = index" style="animation: fadeInUp 0.4s ease-out both"
            [style.animation-delay]="i * 0.04 + 's'">
            <td class="ps-4"><span style="color:#94a3b8; font-weight:700">{{ (currentPage - 1) * rowsPerPage + i + 1
                }}</span></td>
            <td>
              <div class="d-flex align-items-center gap-3">
                <div class="staff-avatar-grad">{{ (leave.staff?.staffName || '?').charAt(0) }}</div>
                <div>
                  <div class="staff-name">{{ leave.staff?.staffName || 'N/A' }}</div>
                  <div class="staff-role">{{ leave.staff?.designation || 'Staff' }}</div>
                </div>
              </div>
            </td>
            <td><span class="category-badge">{{ getLeaveTypeName(leave.leaveType) }}</span></td>
            <td>
              <span style="font-weight: 600; color: #1e293b; font-size: 13px;">
                {{ leave.startDate | date:'dd MMM' }} – {{ leave.endDate | date:'dd MMM yyyy' }}
              </span>
            </td>
            <td class="text-center">
              <div class="duration-count">{{ getDurationDays(leave.startDate, leave.endDate) }}</div>
              <div class="duration-label">Days</div>
            </td>
            <td>
              <span style="color:#64748b; font-size: 13px;" [title]="leave.reason">
                {{ leave.reason.length > 35 ? leave.reason.substring(0, 35) + '...' : leave.reason }}
              </span>
            </td>
            <td class="text-center">
              <span class="status-pill" [ngClass]="{
                  'pending': leave.status === 0,
                  'approved': leave.status === 1,
                  'rejected': leave.status === 2
                }">
                <iconify-icon
                  [icon]="leave.status === 0 ? 'solar:clock-circle-linear' : (leave.status === 1 ? 'solar:check-circle-linear' : 'solar:close-circle-linear')"></iconify-icon>
                {{ getLeaveStatusName(leave.status) }}
              </span>
            </td>
            <td class="text-center">
              <div class="d-flex align-items-center justify-content-center gap-1"
                *ngIf="leave.status === 0 && hasRole('Principal')">
                <button type="button" (click)="openApproveModal(leave)" class="decision-btn-glass approve"
                  title="Approve">
                  <iconify-icon icon="solar:check-read-bold"></iconify-icon>
                </button>
                <button type="button" (click)="openRejectModal(leave)" class="decision-btn-glass reject" title="Reject">
                  <iconify-icon icon="solar:close-square-bold"></iconify-icon>
                </button>
              </div>
              <iconify-icon *ngIf="leave.status !== 0" icon="solar:verified-check-bold-duotone"
                class="processed-icon"></iconify-icon>
            </td>
          </tr>
          <tr *ngIf="paginatedLeaves.length === 0 && !loading">
            <td colspan="8" class="text-center" style="padding: 60px 20px;">
              <iconify-icon icon="solar:sleeping-linear" style="font-size: 4rem; color: #c7d2fe;"></iconify-icon>
              <h5 class="mt-3" style="color: #94a3b8; font-weight: 700;">All Quiet Here</h5>
              <p style="color: #cbd5e1;">No leave requests found for the current selection</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="pagination-bar" *ngIf="filteredLeaves.length > 0">
      <p class="pagination-info mb-0">
        Showing <b>{{ (currentPage - 1) * rowsPerPage + 1 }}</b> to
        <b>{{ Math.min(currentPage * rowsPerPage, filteredLeaves.length) }}</b> of <b>{{ filteredLeaves.length }}</b>
      </p>
      <nav>
        <ul class="pagination-pills">
          <li class="page-item" [class.disabled]="currentPage === 1">
            <a class="page-link" (click)="changePage(currentPage - 1)" href="javascript:void(0)">
              <iconify-icon icon="solar:alt-arrow-left-linear"></iconify-icon>
            </a>
          </li>
          <li class="page-item" *ngFor="let page of [].constructor(totalPages); let i = index"
            [class.active]="currentPage === i + 1">
            <a class="page-link" (click)="changePage(i + 1)" href="javascript:void(0)">{{ i + 1 }}</a>
          </li>
          <li class="page-item" [class.disabled]="currentPage === totalPages">
            <a class="page-link" (click)="changePage(currentPage + 1)" href="javascript:void(0)">
              <iconify-icon icon="solar:alt-arrow-right-linear"></iconify-icon>
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </div>
</div>

<!-- ══════ Decision Modal ══════ -->
<div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
  <div class="modal-glass-box" (click)="$event.stopPropagation()">
    <div class="modal-header-glass">
      <div>
        <h4 [style.color]="modalAction === 'approve' ? '#16a34a' : '#dc2626'">
          {{ modalAction === 'approve' ? 'Approve' : 'Reject' }} Leave
        </h4>
        <p>Final Review</p>
      </div>
      <button type="button" class="modal-close" (click)="closeModal()">
        <iconify-icon icon="solar:close-circle-linear"></iconify-icon>
      </button>
    </div>
    <div class="modal-body-glass" *ngIf="selectedLeave">
      <div class="detail-strip mb-3">
        <div class="d-flex align-items-center gap-3 mb-3">
          <div class="staff-avatar-grad" style="width: 52px; height: 52px; font-size: 18px;">
            {{ (selectedLeave.staff?.staffName || '?').charAt(0) }}
          </div>
          <div class="flex-grow-1">
            <div class="staff-name" style="font-size: 16px;">{{ selectedLeave.staff?.staffName }}</div>
            <span class="category-badge">{{ getLeaveTypeName(selectedLeave.leaveType) }}</span>
          </div>
          <div class="text-end">
            <div class="duration-count">{{ getDurationDays(selectedLeave.startDate, selectedLeave.endDate) }}</div>
            <div class="duration-label">Days</div>
          </div>
        </div>
        <p class="mb-0" style="color: #64748b; font-size: 13px; font-style: italic;">"{{ selectedLeave.reason }}"</p>
      </div>

      <div class="mb-4">
        <label class="form-label-glass">Administrative Remarks</label>
        <textarea class="field-textarea" [(ngModel)]="remarks" name="remarks" rows="3"
          [placeholder]="'Provide reasoning for ' + (modalAction === 'approve' ? 'approval' : 'rejection') + '...'"
          required></textarea>
      </div>

      <div class="d-flex gap-3">
        <button type="button" (click)="closeModal()" class="btn-modal-cancel">Cancel</button>
        <button type="button" (click)="confirmAction()" class="btn-modal-action"
          [class.approve]="modalAction === 'approve'" [class.reject]="modalAction === 'reject'">
          {{ modalAction === 'approve' ? 'APPROVE REQUEST' : 'REJECT REQUEST' }}
        </button>
      </div>
    </div>
  </div>
</div>
<div class="dashboard-main-body">
  <app-breadcrumb [title]="title"></app-breadcrumb>

  <!-- ══════════════ PAGE WRAPPER ══════════════ -->
  <div class="es-page">

    <!-- ── Top Bar ── -->
    <div class="es-topbar">
      <div class="es-topbar-left">
        <div class="es-search-wrap">
          <iconify-icon icon="solar:magnifer-linear" class="es-search-icon"></iconify-icon>
          <input class="es-search-input" type="text" [(ngModel)]="searchTerm" (input)="searchExamSchedules()"
            placeholder="Search exam schedules…" />
        </div>
        <div class="es-show-wrap">
          <span class="es-show-label">Show</span>
          <select class="es-show-select" [(ngModel)]="rowsPerPage" (change)="currentPage = 1; updatePagination()">
            <option [ngValue]="10">10</option>
            <option [ngValue]="25">25</option>
            <option [ngValue]="50">50</option>
          </select>
        </div>
      </div>
      <button class="es-add-btn" (click)="openAddDialog()" *ngIf="authService.hasAnyRole(['Admin', 'Principal'])">
        <iconify-icon icon="solar:add-circle-bold-duotone"></iconify-icon>
        New Schedule
      </button>
    </div>

    <!-- ── Loading Skeleton ── -->
    <div class="es-skeleton-grid" *ngIf="loading">
      <div class="es-skeleton-card" *ngFor="let _ of [1,2,3,4,5,6]">
        <div class="sk-line sk-title"></div>
        <div class="sk-line sk-sub"></div>
        <div class="sk-line sk-date"></div>
      </div>
    </div>

    <!-- ── Empty State ── -->
    <div class="es-empty" *ngIf="!loading && paginatedExamSchedules.length === 0">
      <div class="es-empty-icon">
        <iconify-icon icon="solar:calendar-add-bold-duotone"></iconify-icon>
      </div>
      <h5>No Schedules Found</h5>
      <p>Create your first exam schedule to get started.</p>
      <button class="es-add-btn" (click)="openAddDialog()" *ngIf="authService.hasAnyRole(['Admin', 'Principal'])">
        <iconify-icon icon="solar:add-circle-bold-duotone"></iconify-icon>
        New Schedule
      </button>
    </div>

    <!-- ── Schedule Cards Grid ── -->
    <div class="es-grid" *ngIf="!loading && paginatedExamSchedules.length > 0">
      <div class="es-card" *ngFor="let sch of paginatedExamSchedules; let i = index"
        [style.animation-delay]="(i * 0.06) + 's'">

        <!-- Card accent bar -->
        <div class="es-card-accent" [ngClass]="'accent-' + (i % 5)"></div>

        <!-- Header -->
        <div class="es-card-head">
          <div class="es-card-icon" [ngClass]="'icon-' + (i % 5)">
            <iconify-icon icon="solar:calendar-date-bold-duotone"></iconify-icon>
          </div>
          <span class="es-year-badge">{{ sch.examYear }}</span>
        </div>

        <!-- Name -->
        <h5 class="es-card-name">{{ sch.examScheduleName }}</h5>

        <!-- Date Range -->
        <div class="es-date-row">
          <div class="es-date-block">
            <span class="es-date-label">
              <iconify-icon icon="solar:calendar-linear"></iconify-icon>
              Start
            </span>
            <span class="es-date-val">{{ sch.startDate | date:'dd MMM yyyy' }}</span>
          </div>
          <div class="es-date-arrow">
            <iconify-icon icon="solar:arrow-right-bold-duotone"></iconify-icon>
          </div>
          <div class="es-date-block">
            <span class="es-date-label">
              <iconify-icon icon="solar:calendar-linear"></iconify-icon>
              End
            </span>
            <span class="es-date-val">{{ sch.endDate | date:'dd MMM yyyy' }}</span>
          </div>
        </div>

        <!-- Serial badge -->
        <div class="es-serial">#{{ (currentPage - 1) * rowsPerPage + i + 1 }}</div>

        <!-- Actions -->
        <div class="es-card-actions">
          <button class="es-action-btn view" (click)="openViewDialog(sch)" title="View details">
            <iconify-icon icon="solar:eye-bold-duotone"></iconify-icon>
            <span>View</span>
          </button>
          <button class="es-action-btn edit" *ngIf="authService.hasAnyRole(['Admin', 'Principal'])"
            (click)="openEditDialog(sch)" title="Edit">
            <iconify-icon icon="solar:pen-new-square-bold-duotone"></iconify-icon>
            <span>Edit</span>
          </button>
          <button class="es-action-btn delete" *ngIf="authService.hasAnyRole(['Admin', 'Principal'])"
            (click)="confirmDelete(sch)" title="Delete">
            <iconify-icon icon="solar:trash-bin-trash-bold-duotone"></iconify-icon>
          </button>
        </div>
      </div>
    </div>

    <!-- ── Pagination ── -->
    <div class="es-pagination" *ngIf="filteredExamSchedules.length > 0">
      <span class="es-pagination-info">
        Showing {{ (currentPage - 1) * rowsPerPage + 1 }}–{{ Math.min(currentPage * rowsPerPage,
        filteredExamSchedules.length) }}
        of {{ filteredExamSchedules.length }}
      </span>
      <div class="es-pagination-buttons">
        <button class="es-page-btn" [disabled]="currentPage === 1" (click)="changePage(currentPage - 1)">
          <iconify-icon icon="solar:alt-arrow-left-linear"></iconify-icon>
        </button>
        <button class="es-page-btn" *ngFor="let page of [].constructor(totalPages); let i = index"
          [class.active]="currentPage === i + 1" (click)="changePage(i + 1)">
          {{ i + 1 }}
        </button>
        <button class="es-page-btn" [disabled]="currentPage === totalPages" (click)="changePage(currentPage + 1)">
          <iconify-icon icon="solar:alt-arrow-right-linear"></iconify-icon>
        </button>
      </div>
    </div>

  </div>
</div>

<!-- ═══════════════════════════════════════════
     ADD / EDIT MODAL
═══════════════════════════════════════════ -->
<div *ngIf="showAddEditDialog" class="es-overlay" (click)="closeDialog()">
  <div class="es-modal" (click)="$event.stopPropagation()">
    <div class="es-modal-header">
      <div class="es-modal-title">
        <div class="es-modal-icon">
          <iconify-icon
            [icon]="isEditMode ? 'solar:pen-new-square-bold-duotone' : 'solar:add-circle-bold-duotone'"></iconify-icon>
        </div>
        <div>
          <h5>{{ isEditMode ? 'Edit Schedule' : 'New Exam Schedule' }}</h5>
          <p>{{ isEditMode ? 'Update the exam schedule details' : 'Create a new exam schedule' }}</p>
        </div>
      </div>
      <button class="es-modal-close" (click)="closeDialog()">
        <iconify-icon icon="solar:close-circle-bold-duotone"></iconify-icon>
      </button>
    </div>

    <div class="es-modal-body">
      <form [formGroup]="form" (ngSubmit)="saveExamSchedule()">
        <div class="es-form-group full">
          <label class="es-label">Schedule Name <span class="req">*</span></label>
          <input class="es-input" type="text" formControlName="examScheduleName" placeholder="e.g. Final Term 2025"
            [class.invalid]="form.get('examScheduleName')?.invalid && form.get('examScheduleName')?.touched" />
        </div>
        <div class="es-form-row">
          <div class="es-form-group">
            <label class="es-label">Start Date <span class="req">*</span></label>
            <input class="es-input" type="date" formControlName="startDate"
              [class.invalid]="form.get('startDate')?.invalid && form.get('startDate')?.touched" />
          </div>
          <div class="es-form-group">
            <label class="es-label">End Date <span class="req">*</span></label>
            <input class="es-input" type="date" formControlName="endDate"
              [class.invalid]="form.get('endDate')?.invalid && form.get('endDate')?.touched" />
          </div>
        </div>
        <div class="es-form-group full">
          <label class="es-label">Academic Year <span class="req">*</span></label>
          <input class="es-input" type="text" formControlName="examYear" placeholder="e.g. 2025"
            [class.invalid]="form.get('examYear')?.invalid && form.get('examYear')?.touched" />
        </div>
      </form>
    </div>

    <div class="es-modal-footer">
      <button class="es-btn-secondary" (click)="closeDialog()">Cancel</button>
      <button class="es-btn-primary" (click)="saveExamSchedule()" [disabled]="form.invalid">
        <iconify-icon
          [icon]="isEditMode ? 'solar:diskette-bold-duotone' : 'solar:add-circle-bold-duotone'"></iconify-icon>
        {{ isEditMode ? 'Update Schedule' : 'Create Schedule' }}
      </button>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════
     VIEW DETAILS MODAL
═══════════════════════════════════════════ -->
<div *ngIf="showViewDialog && selectedSchedule" class="es-overlay" (click)="closeDialog()">
  <div class="es-modal es-modal-view" (click)="$event.stopPropagation()">
    <div class="es-modal-header">
      <div class="es-modal-title">
        <div class="es-modal-icon view-icon">
          <iconify-icon icon="solar:calendar-date-bold-duotone"></iconify-icon>
        </div>
        <div>
          <h5>Schedule Details</h5>
          <p>Full information about this exam schedule</p>
        </div>
      </div>
      <button class="es-modal-close" (click)="closeDialog()">
        <iconify-icon icon="solar:close-circle-bold-duotone"></iconify-icon>
      </button>
    </div>

    <div class="es-modal-body">
      <div class="es-view-name-banner">
        <iconify-icon icon="solar:calendar-date-bold-duotone"></iconify-icon>
        {{ selectedSchedule.examScheduleName }}
      </div>
      <div class="es-view-grid">
        <div class="es-view-item">
          <span class="es-view-label">Academic Year</span>
          <span class="es-view-val year-val">{{ selectedSchedule.examYear }}</span>
        </div>
        <div class="es-view-item">
          <span class="es-view-label">Start Date</span>
          <span class="es-view-val">{{ selectedSchedule.startDate | date:'MMMM dd, yyyy' }}</span>
        </div>
        <div class="es-view-item">
          <span class="es-view-label">End Date</span>
          <span class="es-view-val">{{ selectedSchedule.endDate | date:'MMMM dd, yyyy' }}</span>
        </div>
        <div class="es-view-item" *ngIf="selectedSchedule.startDate && selectedSchedule.endDate">
          <span class="es-view-label">Duration</span>
          <span class="es-view-val">
            {{ getDaysDifference(selectedSchedule.startDate, selectedSchedule.endDate) }} days
          </span>
        </div>
      </div>
    </div>

    <div class="es-modal-footer">
      <button class="es-btn-secondary" (click)="closeDialog()">Close</button>
      <button class="es-btn-primary" *ngIf="authService.hasAnyRole(['Admin', 'Principal'])"
        (click)="openEditDialog(selectedSchedule); closeDialog()">
        <iconify-icon icon="solar:pen-new-square-bold-duotone"></iconify-icon>
        Edit Schedule
      </button>
    </div>
  </div>
</div>
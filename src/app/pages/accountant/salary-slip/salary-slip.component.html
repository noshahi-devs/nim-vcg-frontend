<div class="dashboard-main-body">
  <app-breadcrumb [title]="title"></app-breadcrumb>

  <!-- Search Staff Section -->
  <div class="glass-card mb-4" style="padding: 24px;">
    <div class="card-body p-0">
      <div class="search-input-wrapper">
        <input type="text" class="form-control-premium" [(ngModel)]="searchQuery"
          placeholder="Search by staff name, ID, or role..."
          style="background: rgba(255,255,255,0.7); border: 1px solid rgba(0,0,0,0.1); border-radius: 12px; padding: 12px 15px 12px 45px; width: 100%;" />
        <iconify-icon icon="mdi:magnify" class="search-icon-float"
          style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); font-size: 20px; color: #64748b;"></iconify-icon>
      </div>
    </div>
  </div>

  <!-- Salary Slips Cards Grid -->
  <div class="row g-4 mb-4">
    <div class="col-xxl-4 col-md-6" *ngFor="let slip of paginatedRecords">
      <div class="salary-card-glass">
        <div class="card-accent-bar"></div>

        <!-- Profile Header -->
        <div class="profile-section">
          <div class="avatar-glass">
            {{ getProfileInitials(slip.staffName) }}
          </div>
          <div class="staff-info-text">
            <h5 class="staff-name">{{ slip.staffName }}</h5>
            <div class="d-flex align-items-center">
              <span class="staff-id-badge">{{ slip.staffId }}</span>
              <span class="staff-role">{{ slip.role }}</span>
            </div>
          </div>
        </div>

        <!-- Details -->
        <div class="details-section">
          <div class="detail-row">
            <span class="detail-label">Month</span>
            <span class="detail-value text-primary">{{ getMonthName(slip.month) }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Payment Date</span>
            <span class="detail-value">{{ slip.date | date:'mediumDate' }}</span>
          </div>

          <!-- Earnings -->
          <div class="section-header earnings">
            <iconify-icon icon="mdi:cash-plus"></iconify-icon>
            Earnings
          </div>
          <div class="sub-detail">
            <span>Basic Salary</span>
            <span class="fw-bold">PKR {{ slip.basicSalary | number }}</span>
          </div>
          <div class="sub-detail" *ngIf="slip.festivalBonus > 0">
            <span>Festival Bonus</span>
            <span class="value-positive">PKR {{ slip.festivalBonus | number }}</span>
          </div>
          <div class="sub-detail" *ngIf="slip.allowance > 0">
            <span>Allowances</span>
            <span class="value-positive">PKR {{ (slip.allowance + slip.medicalAllowance + slip.housingAllowance +
              slip.transportationAllowance) | number }}</span>
          </div>

          <!-- Deductions -->
          <div class="section-header deductions" *ngIf="slip.savingFund > 0 || slip.taxes > 0">
            <iconify-icon icon="mdi:cash-minus"></iconify-icon>
            Deductions
          </div>
          <div class="sub-detail" *ngIf="slip.savingFund > 0">
            <span>Saving Fund</span>
            <span class="value-negative">-PKR {{ slip.savingFund | number }}</span>
          </div>
          <div class="sub-detail" *ngIf="slip.taxes > 0">
            <span>Taxes</span>
            <span class="value-negative">-PKR {{ slip.taxes | number }}</span>
          </div>

          <!-- Net Salary -->
          <div class="net-salary-block">
            <span class="net-salary-label">Net Amount Paid</span>
            <div class="net-salary-value">PKR {{ slip.netSalary | number }}</div>
          </div>

          <!-- Status -->
          <div class="print-status">
            <div class="status-check">
              <iconify-icon icon="mdi:check-decagram"></iconify-icon>
              Payment Successful
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="btn-group-premium">
          <button class="btn-premium-outline" (click)="printDetailedReceipt(slip)">
            <iconify-icon icon="mdi:printer-eye" style="font-size: 18px;"></iconify-icon>
            Slip
          </button>
          <button class="btn-premium-outline" (click)="printThermalReceipt(slip)">
            <iconify-icon icon="mdi:receipt-text-outline" style="font-size: 18px;"></iconify-icon>
            Thermal
          </button>
          <div class="btn-success-check" title="Transaction Verified">
            <iconify-icon icon="mdi:shield-check"></iconify-icon>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div class="col-12" *ngIf="filteredRecords.length === 0">
      <div class="empty-state-card">
        <iconify-icon icon="mdi:account-search-outline" class="empty-icon"></iconify-icon>
        <h4 class="fw-bold text-dark">Find Staff Salary Slips</h4>
        <p class="text-secondary mx-auto" style="max-width: 400px;">
          Enter a staff name or ID in the search box above to view their payment history and generate salary slips.
        </p>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-3 mt-5"
    *ngIf="filteredRecords.length > 0">
    <span class="text-secondary fw-medium">
      Showing <strong>{{ paginationStart }}</strong> to <strong>{{ paginationEnd }}</strong> of {{
      filteredRecords.length }} records
    </span>
    <nav>
      <ul class="pagination mb-0 gap-2">
        <li class="page-item">
          <button class="btn-premium-outline px-3" [class.disabled]="currentPage === 1"
            (click)="changePage(currentPage - 1)">
            <iconify-icon icon="mdi:chevron-left"></iconify-icon>
          </button>
        </li>
        <li class="page-item" *ngFor="let page of totalPagesArray">
          <button class="btn-premium-outline px-3" [class.bg-primary]="currentPage === page"
            [class.text-white]="currentPage === page" [class.border-primary]="currentPage === page"
            (click)="changePage(page)">
            {{ page }}
          </button>
        </li>
        <li class="page-item">
          <button class="btn-premium-outline px-3" [class.disabled]="currentPage === totalPages"
            (click)="changePage(currentPage + 1)">
            <iconify-icon icon="mdi:chevron-right"></iconify-icon>
          </button>
        </li>
      </ul>
    </nav>
  </div>
</div>

<!-- Print Templates Hidden -->
<div id="detailed-receipt" style="display: none;" *ngIf="selectedSlip">
  <div style="max-width: 800px; margin: 0 auto; padding: 40px; font-family: Arial, sans-serif;">
    <div style="text-align: center; border-bottom: 3px solid #800020; padding-bottom: 20px; margin-bottom: 30px;">
      <h1 style="color: #800020; margin: 0 0 10px 0;">Noshahi Institute Manager</h1>
      <p style="margin: 0; color: #666;">Salary Payment Receipt</p>
    </div>
    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
      <h3 style="margin: 0 0 15px 0;">Staff: {{ selectedSlip.staffName }}</h3>
      <p style="margin: 5px 0;"><strong>ID:</strong> {{ selectedSlip.staffId }} | <strong>Role:</strong> {{
        selectedSlip.role }}</p>
    </div>
    <h3 style="margin: 20px 0;">Salary Payment History</h3>
    <table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd;">
      <thead>
        <tr style="background: #800020; color: white;">
          <th style="padding: 12px; border: 1px solid #ddd;">Month</th>
          <th style="padding: 12px; border: 1px solid #ddd;">Date</th>
          <th style="padding: 12px; border: 1px solid #ddd;">Fixed</th>
          <th style="padding: 12px; border: 1px solid #ddd;">Bonus</th>
          <th style="padding: 12px; border: 1px solid #ddd;">Deduction</th>
          <th style="padding: 12px; border: 1px solid #ddd;">Net Paid</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let record of getStaffSalaryHistory(selectedSlip.staffId)">
          <td style="padding: 12px; border: 1px solid #ddd;">{{ getMonthName(record.month) }}</td>
          <td style="padding: 12px; border: 1px solid #ddd;">{{ record.date }}</td>
          <td style="padding: 12px; border: 1px solid #ddd;">PKR {{ record.basicSalary | number }}</td>
          <td style="padding: 12px; border: 1px solid #ddd; color: #28a745;">PKR {{ record.festivalBonus | number }}
          </td>
          <td style="padding: 12px; border: 1px solid #ddd; color: #dc3545;">PKR {{ (record.savingFund + record.taxes) |
            number }}</td>
          <td style="padding: 12px; border: 1px solid #ddd; font-weight: bold;">PKR {{ record.netSalary | number }}</td>
        </tr>
      </tbody>
    </table>
    <div style="text-align: center; margin-top: 30px; color: #666; font-size: 12px;">
      <p>This is a computer-generated receipt.</p>
    </div>
  </div>
</div>

<div id="thermal-receipt" style="display: none;" *ngIf="selectedSlip">
  <div style="width: 300px; margin: 0 auto; padding: 10px; font-family: 'Courier New', monospace; font-size: 12px;">
    <div style="text-align: center; border-bottom: 1px dashed #000; padding-bottom: 10px; margin-bottom: 10px;">
      <h2 style="margin: 0; font-size: 16px;">SCHOOL MANAGEMENT</h2>
      <p style="margin: 5px 0 0 0; font-size: 10px;">SALARY RECEIPT</p>
    </div>
    <p style="margin: 2px 0;">ID: {{ selectedSlip.staffId }}</p>
    <p style="margin: 2px 0;">Name: {{ selectedSlip.staffName }}</p>
    <p style="margin: 2px 0;">Role: {{ selectedSlip.role }}</p>
    <p style="margin: 2px 0;">Month: {{ getMonthName(selectedSlip.month) }}</p>
    <p style="margin: 2px 0;">Date: {{ selectedSlip.date }}</p>
    <div style="border-top: 1px dashed #000; margin: 10px 0;"></div>
    <p style="margin: 2px 0;">Fixed: PKR {{ selectedSlip.basicSalary | number }}</p>
    <p style="margin: 2px 0;">Bonus: PKR {{ selectedSlip.festivalBonus | number }}</p>
    <p style="margin: 2px 0;">Deduction: PKR {{ (selectedSlip.savingFund + selectedSlip.taxes) | number }}</p>
    <div style="border-top: 1px dashed #000; margin: 10px 0;"></div>
    <p style="margin: 2px 0; font-weight: bold; font-size: 14px;">NET: PKR {{ selectedSlip.netSalary | number }}</p>
    <div style="text-align: center; margin-top: 15px; font-size: 10px;">
      <p>Status: {{ selectedSlip.status }}</p>
      <p>Thank You!</p>
    </div>
  </div>
</div>
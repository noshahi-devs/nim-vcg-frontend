<div class="dashboard-main-body">
  <app-breadcrumb [title]="title"></app-breadcrumb>

  <!-- ===================== STATS ROWS ===================== -->
  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-icon-wrapper indigo">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
          <circle cx="8.5" cy="7" r="4" />
          <polyline points="17 11 19 13 23 9" />
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-label">Total Defaulters</span>
        <h3 class="stat-value">{{ totalDefaulters }}</h3>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon-wrapper orange">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="1" x2="12" y2="23" />
          <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-label">Outstanding Amount</span>
        <h3 class="stat-value pending">Rs. {{ totalOutstanding | number }}</h3>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon-wrapper red">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10" />
          <line x1="12" y1="8" x2="12" y2="12" />
          <line x1="12" y1="16" x2="12.01" y2="16" />
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-label">Critical Cases</span>
        <h3 class="stat-value text-danger">{{ criticalCount }}</h3>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon-wrapper warning">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
          <line x1="12" y1="9" x2="12" y2="13" />
          <line x1="12" y1="17" x2="12.01" y2="17" />
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-label">Warning Cases</span>
        <h3 class="stat-value text-warning">{{ warningCount }}</h3>
      </div>
    </div>
  </div>

  <!-- ===================== FILTER & ACTION CARD ===================== -->
  <div class="fee-card">

    <div class="fee-card-header premium-header">
      <div class="header-filters">
        <!-- Search -->
        <div class="search-wrapper-premium">
          <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8" />
            <path d="M21 21l-4.35-4.35" />
          </svg>
          <input class="search-input-premium" [(ngModel)]="searchQuery" (input)="onSearchChange()"
            placeholder="Search by student name or class..." />
        </div>

        <!-- Class Filter -->
        <div class="filter-group">
          <label class="filter-label">Class</label>
          <div class="select-wrapper-premium">
            <select class="field-select-premium" [(ngModel)]="selectedClass" (change)="onFilterChange()">
              <option value="all">All Classes</option>
              <option *ngFor="let cls of uniqueClasses" [value]="cls">{{ cls }}</option>
            </select>
            <svg class="field-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <polyline points="6 9 12 15 18 9" />
            </svg>
          </div>
        </div>

        <!-- Status Filter -->
        <div class="filter-group">
          <label class="filter-label">Status</label>
          <div class="select-wrapper-premium">
            <select class="field-select-premium" [(ngModel)]="selectedStatus" (change)="onFilterChange()">
              <option value="all">All Status</option>
              <option value="Critical">Critical</option>
              <option value="Warning">Warning</option>
              <option value="Overdue">Overdue</option>
            </select>
            <svg class="field-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <polyline points="6 9 12 15 18 9" />
            </svg>
          </div>
        </div>

        <!-- Min Amount -->
        <div class="filter-group">
          <label class="filter-label">Min Amount</label>
          <div class="input-wrapper-premium">
            <input type="number" class="field-input-premium" [(ngModel)]="minAmount" (input)="onFilterChange()"
              placeholder="0" />
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="header-actions">
        <button class="btn-primary-premium" (click)="loadDefaulters()" title="Refresh Data">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />
          </svg>
          Refresh
        </button>
        <button class="btn-success-premium" (click)="sendBulkReminders()" [disabled]="filteredDefaulters.length === 0"
          title="Send Bulk Reminders">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" />
          </svg>
          Bulk Reminders
        </button>
        <div class="action-divider"></div>
        <button class="btn-secondary-premium" (click)="exportCSV()" [disabled]="filteredDefaulters.length === 0"
          title="Export CSV">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
            <polyline points="7 10 12 15 17 10" />
            <line x1="12" y1="15" x2="12" y2="3" />
          </svg>
          Export
        </button>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading" class="loading-container">
      <div class="spinner-premium"></div>
      <p>Fetching defaulters data...</p>
    </div>

    <!-- Table Body -->
    <div *ngIf="!isLoading" class="fee-card-body p-0">
      <div class="table-wrapper">
        <table class="fee-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Student</th>
              <th>Class</th>
              <th>Fee Type</th>
              <th>Amount</th>
              <th>Due Date</th>
              <th>Overdue</th>
              <th>Status</th>
              <th class="text-center">Action</th>
            </tr>
          </thead>
          <tbody>
            <tr class="table-row" *ngFor="let d of paginatedDefaulters; let i = index">
              <td><span class="row-num">#{{ (currentPage - 1) * itemsPerPage + i + 1 }}</span></td>
              <td>
                <div class="student-info-premium">
                  <div class="student-avatar" [style.background]="'linear-gradient(135deg, #6366f1, #4f46e5)'">
                    {{ d.studentName.charAt(0) }}
                  </div>
                  <span class="student-name-premium">{{ d.studentName }}</span>
                </div>
              </td>
              <td><span class="enrollment-badge">{{ d.className }} - {{ d.section }}</span></td>
              <td><span class="fee-type-val">{{ d.feeType }}</span></td>
              <td><span class="amount-val-def">Rs. {{ d.amount | number }}</span></td>
              <td><span class="date-val-def">{{ d.dueDate | date:'mediumDate' }}</span></td>
              <td>
                <span class="overdue-badge">
                  {{ d.daysOverdue }} Days
                </span>
              </td>
              <td>
                <span class="status-chip" [class.critical]="d.status === 'Critical'"
                  [class.warning]="d.status === 'Warning'" [class.overdue]="d.status === 'Overdue'">
                  {{ d.status }}
                </span>
              </td>
              <td class="text-center">
                <button class="icon-btn-premium send-btn" (click)="sendReminder(d)" title="Send Reminder">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" />
                  </svg>
                </button>
              </td>
            </tr>
            <tr *ngIf="paginatedDefaulters.length === 0">
              <td colspan="9" class="empty-state-premium">
                <div class="empty-content-premium">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="12" cy="12" r="10" />
                    <path d="M8 12h8" />
                  </svg>
                  <p>No defaulters match the current filters.</p>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination Footer -->
      <div class="pagination-footer-premium" *ngIf="filteredDefaulters.length > 0">
        <div class="show-entries">
          <span>Show</span>
          <select class="entries-select-premium" [(ngModel)]="itemsPerPage" (change)="currentPage=1; applyFilters()">
            <option [value]="10">10</option>
            <option [value]="25">25</option>
            <option [value]="50">50</option>
            <option [value]="100">100</option>
          </select>
          <span>entries</span>
        </div>

        <div class="pagination-info-premium">
          Showing {{ Math.min((currentPage-1)*itemsPerPage + 1, filteredDefaulters.length) }} to {{
          Math.min(currentPage*itemsPerPage, filteredDefaulters.length) }} of {{ filteredDefaulters.length }} entries
        </div>

        <div class="pagination-controls-premium">
          <button class="page-btn-premium" [disabled]="currentPage===1" (click)="changePage(currentPage-1)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15 18 9 12 15 6" />
            </svg>
          </button>
          <button class="page-btn-premium" *ngFor="let page of [].constructor(totalPages); let i=index"
            [class.active]="currentPage===i+1" (click)="changePage(i+1)">{{ i+1 }}</button>
          <button class="page-btn-premium" [disabled]="currentPage===totalPages" (click)="changePage(currentPage+1)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 18 15 12 9 6" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="dashboard-main-body">
  <app-breadcrumb [title]="title"></app-breadcrumb>

  <form #entryForm="ngForm" (ngSubmit)="onSubmit()">

    <!-- Top Metadata Section -->
    <div class="fee-card mb-24">
      <!-- Header -->
      <div class="fee-card-header bg-base border-bottom px-24 py-16 d-flex align-items-center gap-12">
        <div
          class="w-40-px h-40-px rounded-circle bg-primary-50 d-flex justify-content-center align-items-center text-primary-600 flex-shrink-0">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
            <polygon
              points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
          </svg>
        </div>
        <div>
          <h6 class="text-md fw-bold mb-0 text-secondary-dark">Examination Details</h6>
          <p class="text-sm text-secondary-light mb-0">Select criteria configuration to fetch students for grading</p>
        </div>
      </div>

      <!-- Form Grid -->
      <div class="fee-card-body p-24">
        <div class="row gy-16">

          <!-- Mark Entry Date -->
          <div class="col-lg-3 col-md-4 col-sm-6">
            <label class="form-label fw-semibold text-secondary-dark mb-8 text-sm">Date <span
                class="text-danger-main">*</span></label>
            <div class="position-relative">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"
                class="position-absolute text-secondary-light" style="left: 14px; top: 12px; pointer-events: none;">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                <line x1="16" y1="2" x2="16" y2="6" />
                <line x1="8" y1="2" x2="8" y2="6" />
                <line x1="3" y1="10" x2="21" y2="10" />
              </svg>
              <input type="date" id="markEntryDate" name="markEntryDate" #markEntryDate="ngModel"
                [(ngModel)]="markEntry.markEntryDate" required class="form-control radius-8 bg-base border-neutral-200"
                style="padding-left: 38px;">
            </div>
          </div>

          <!-- Staff Assignee -->
          <div class="col-lg-3 col-md-4 col-sm-6">
            <label class="form-label fw-semibold text-secondary-dark mb-8 text-sm">Staff <span
                class="text-danger-main">*</span></label>
            <select id="staffId" name="staffId" #staffId="ngModel" [(ngModel)]="markEntry.staffId"
              class="form-select radius-8 bg-base border-neutral-200 text-secondary-dark" required>
              <option value="0" disabled selected>-- Select Staff --</option>
              <option *ngFor="let staff of staffList" [value]="staff.staffId">{{ staff.staffName }}</option>
            </select>
          </div>

          <!-- Exam Schedule -->
          <div class="col-lg-3 col-md-4 col-sm-6">
            <label class="form-label fw-semibold text-secondary-dark mb-8 text-sm">Exam Schedule <span
                class="text-danger-main">*</span></label>
            <select id="examScheduleId" name="examScheduleId" #examScheduleId="ngModel"
              [(ngModel)]="markEntry.examScheduleId"
              class="form-select radius-8 bg-base border-neutral-200 text-secondary-dark" required>
              <option value="0" disabled selected>-- Select Schedule --</option>
              <option *ngFor="let examSchedul of examSchedulesVM" [value]="examSchedul.examScheduleId">{{
                examSchedul.examScheduleName }}</option>
            </select>
          </div>

          <!-- Exam Type -->
          <div class="col-lg-3 col-md-4 col-sm-6">
            <label class="form-label fw-semibold text-secondary-dark mb-8 text-sm">Exam Type <span
                class="text-danger-main">*</span></label>
            <select id="examTypeId" name="examTypeId" #examTypeId="ngModel" [(ngModel)]="markEntry.examTypeId"
              class="form-select radius-8 bg-base border-neutral-200 text-secondary-dark" required>
              <option value="0" disabled selected>-- Select Type --</option>
              <option *ngFor="let examType of examtypes" [value]="examType.examTypeId">{{ examType.examTypeName }}
              </option>
            </select>
          </div>

          <!-- Subject -->
          <div class="col-lg-3 col-md-4 col-sm-6">
            <label class="form-label fw-semibold text-secondary-dark mb-8 text-sm">Subject <span
                class="text-danger-main">*</span></label>
            <select id="subjectId" name="subjectId" #subjectId="ngModel" [(ngModel)]="markEntry.subjectId"
              class="form-select radius-8 bg-base border-neutral-200 text-secondary-dark" required>
              <option value="0" disabled selected>-- Select Subject --</option>
              <option *ngFor="let sbject of subjects" [value]="sbject.subjectId">{{ sbject.subjectName }}</option>
            </select>
          </div>

          <!-- Standard -->
          <div class="col-lg-3 col-md-4 col-sm-6">
            <label class="form-label fw-semibold text-secondary-dark mb-8 text-sm">Standard <span
                class="text-danger-main">*</span></label>
            <select id="standardId" name="standardId" #standardId="ngModel" [(ngModel)]="markEntry.standardId"
              class="form-select radius-8 bg-base border-neutral-200 text-secondary-dark" required>
              <option value="0" disabled selected>-- Select Standard --</option>
              <option *ngFor="let standard of standards" [value]="standard.standardId">{{ standard.standardName }}
              </option>
            </select>
          </div>

          <!-- Score Logic Targets -->
          <div class="col-lg-6 col-md-12 d-flex gap-16">
            <div class="w-50">
              <label class="form-label fw-semibold text-secondary-dark mb-8 text-sm">Total Marks <span
                  class="text-danger-main">*</span></label>
              <input type="number" id="totalMarks" name="totalMarks" [(ngModel)]="markEntry.totalMarks"
                class="form-control radius-8 bg-base border-neutral-200 fw-bold text-primary-main" required>
            </div>
            <div class="w-50">
              <label class="form-label fw-semibold text-secondary-dark mb-8 text-sm">Passing Marks <span
                  class="text-danger-main">*</span></label>
              <input type="number" id="passMarks" name="passMarks" [(ngModel)]="markEntry.passMarks"
                class="form-control radius-8 bg-base border-neutral-200 fw-bold text-success-main" required>
            </div>
          </div>

        </div>

        <!-- Fetch Button Wrapper -->
        <div class="d-flex justify-content-end mt-24 pt-24 border-top border-neutral-200"
          *ngIf="markEntry.studentMarksDetails.length == 0">
          <button type="button"
            class="btn-primary-gradient d-flex align-items-center gap-8 py-10 px-24 radius-8 shadow-sm"
            (click)="loadStudentsMark()" [disabled]="!markEntry.standardId || !markEntry.subjectId">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="18" height="18">
              <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" />
            </svg>
            Fetch Enrolled Students
          </button>
        </div>
      </div>
    </div>


    <!-- Active Grading Table -->
    <div class="fee-card mb-24 animate__animated animate__fadeInUp" *ngIf="markEntry.studentMarksDetails.length > 0">
      <div class="fee-card-header bg-base border-bottom px-24 py-16 d-flex align-items-center justify-content-between">
        <div>
          <h6 class="text-md fw-bold mb-0 text-secondary-dark">Student Grade Entries</h6>
          <p class="text-sm text-secondary-light mb-0">Fill out each student's specific scores and pass/fail assignments
          </p>
        </div>
        <span class="amount-chip fw-bold" style="background: #eff6ff; color: #3b82f6;">{{
          markEntry.studentMarksDetails.length }} Students Loaded</span>
      </div>

      <div class="fee-card-body p-0 table-responsive border-bottom-0">
        <table class="fee-table mb-0">
          <thead>
            <tr>
              <th scope="col" style="width: 80px;">Roll No</th>
              <th scope="col">Student Name</th>
              <th scope="col" class="text-center" style="width: 130px;">Score <span class="text-danger-main">*</span>
              </th>
              <th scope="col" style="width: 120px;">Grade</th>
              <th scope="col" style="width: 150px;">Status</th>
              <th scope="col">Teacher Feedback</th>
            </tr>
          </thead>
          <tbody>
            <tr class="table-row align-middle border-bottom border-neutral-200"
              *ngFor="let student of markEntry.studentMarksDetails ; let i =index;">
              <!-- Logic assumes ID but stylized as Roll No / ID badge -->
              <td><span
                  class="text-secondary-light fw-bold bg-neutral-100 px-8 py-4 radius-4 border border-neutral-200">#{{
                  student.studentId }}</span></td>

              <td>
                <div class="d-flex align-items-center gap-12">
                  <div
                    class="w-32-px h-32-px rounded-circle bg-primary-50 d-flex justify-content-center align-items-center text-primary-600 fw-bold border border-primary-200 text-xs shadow-sm">
                    {{ student.studentName.charAt(0) }}
                  </div>
                  <h6 class="text-sm text-secondary-dark fw-bold mb-0 student-name">{{ student.studentName }}</h6>
                </div>
              </td>

              <!-- Inline Inputs styled as borderless components until focused -->
              <td class="text-center">
                <input type="number" id="obtainedScore-{{i}}" name="obtainedScore-{{i}}" #obtainedScore="ngModel"
                  [(ngModel)]="student.obtainedScore"
                  class="form-control form-control-sm text-center fw-bold text-primary-main bg-base focus-ring"
                  style="border: 1px solid #e2e8f0; border-radius: 6px; width: 100px; margin: 0 auto; height: 36px;"
                  required>
              </td>

              <td>
                <select [(ngModel)]="student.grade" name="grade-{{i}}"
                  class="form-select form-select-sm fw-medium text-secondary-dark bg-base focus-ring"
                  style="border: 1px solid #e2e8f0; border-radius: 6px; height: 36px; padding: 4px 24px 4px 8px;">
                  <option *ngFor="let grade of gradesSystemValues" [value]="grade">{{ grade }}</option>
                </select>
              </td>

              <td>
                <select [(ngModel)]="student.passStatus" name="passStatus-{{i}}"
                  class="form-select form-select-sm fw-semibold bg-base focus-ring"
                  [ngClass]="student.passStatus === 'Fail' ? 'text-danger-main border-danger-200 bg-danger-50' : (student.passStatus === 'Pass' ? 'text-success-main border-success-200 bg-success-50' : 'text-secondary-dark')"
                  style="border: 1px solid #e2e8f0; border-radius: 6px; height: 36px; padding: 4px 24px 4px 8px;">
                  <option *ngFor="let status of passFailStatusValues" [value]="status">{{ status }}</option>
                </select>
              </td>

              <td>
                <input type="text" [(ngModel)]="student.feedback" name="feedback-{{i}}"
                  class="form-control form-control-sm text-secondary-dark bg-base focus-ring"
                  placeholder="Optional comments..."
                  style="border: 1px solid #e2e8f0; border-radius: 6px; height: 36px;">
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Final Submission Footer -->
      <div class="px-24 py-20 bg-neutral-50 d-flex justify-content-end align-items-center gap-16"
        style="border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; border-top: 1px solid #e2e8f0;">
        <span class="text-sm text-secondary-light me-auto d-flex align-items-center gap-8">
          <svg viewBox="0 0 24 24" fill="none" class="text-warning-main" stroke="currentColor" stroke-width="2"
            width="16" height="16">
            <circle cx="12" cy="12" r="10" />
            <line x1="12" y1="8" x2="12" y2="12" />
            <line x1="12" y1="16" x2="12.01" y2="16" />
          </svg>
          Review all entered grades thoroughly prior to submission.
        </span>
        <button type="submit" *ngIf="authService.hasAnyRole(['Admin', 'Teacher'])"
          class="btn btn-primary d-flex align-items-center gap-8 py-10 px-32 radius-8 shadow-sm fw-bold">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="18" height="18">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
            <polyline points="17 21 17 13 7 13 7 21" />
            <polyline points="7 3 7 8 15 8" />
          </svg>
          Save Grades Directory
        </button>
      </div>

    </div>

  </form>
</div>
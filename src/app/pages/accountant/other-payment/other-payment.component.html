<div class="dashboard-main-body">
  <app-breadcrumb [title]="title"></app-breadcrumb>

  <div class="card h-100 p-0 radius-12">
    <div class="card-header border-bottom bg-base py-16 px-24 d-flex align-items-center flex-wrap gap-3 justify-content-between">
      <div class="d-flex align-items-center flex-wrap gap-3">
        <span class="text-md fw-medium text-secondary-light mb-0">Show</span>
        <select class="form-select form-select-sm w-auto ps-12 py-6 radius-12 h-40-px" [(ngModel)]="rowsPerPage" (change)="currentPage=1; updatePagination()">
          <option [value]="10">10</option>
          <option [value]="25">25</option>
          <option [value]="50">50</option>
        </select>

        <form class="navbar-search ms-3">
          <input type="text" class="bg-base h-40-px w-auto" [(ngModel)]="searchTerm" (input)="searchPayments()" name="search" placeholder="Search Student / Payment ID..." />
        </form>
      </div>

      <button type="button" (click)="openAddDialog()" class="btn btn-primary text-sm btn-sm px-12 py-12 radius-8 d-flex align-items-center gap-2">
        Add Other Payment
      </button>
    </div>

    <div class="card-body p-24">
     <div class="table-responsive scroll-sm">
  <table class="table bordered-table sm-table mb-0">
    <thead>
      <tr>
        <th>Payment ID</th>
        <th>Student Name</th>
        <th>Enrollment #</th>
        <th>Total Amount</th>
        <th>Amount Paid</th>
        <th>Amount Remaining</th>
        <th>Payment Date</th>
        <th class="text-center">Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let p of paginatedPayments; let i = index">
        <!-- <td>{{ (currentPage-1)*rowsPerPage + i + 1 }}</td> -->
        <td>{{ p.othersPaymentId }}</td>
        <td>{{ p.student?.studentName }}</td>
        <td>{{ p.student?.enrollmentNo }}</td>
        <td>{{ p.totalAmount }}</td>
        <td>{{ p.amountPaid }}</td>
        <td>{{ p.amountRemaining }}</td>
        <td>{{ p.paymentDate | date:'shortDate' }}</td>
        <td class="text-center">
          <button class="btn btn-info btn-sm me-1" (click)="openViewDialog(p)">View</button>
          <button class="btn btn-success btn-sm me-1" (click)="openEditDialog(p)">Edit</button>
          <button class="btn btn-danger btn-sm" (click)="confirmDelete(p)">Delete</button>
        </td>
      </tr>
      <tr *ngIf="paginatedPayments.length===0">
        <td colspan="9" class="text-center py-24 text-secondary-light">No payments found</td>
      </tr>
    </tbody>
  </table>
</div>


      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mt-24">
        <span>Showing {{ (currentPage-1)*rowsPerPage + 1 }} to {{ toEntry }} of {{ filteredPayments.length }} entries</span>
        <ul class="pagination d-flex flex-wrap align-items-center gap-2 justify-content-center">
          <li class="page-item">
            <a class="page-link" [class.disabled]="currentPage===1" (click)="changePage(currentPage-1)" href="javascript:void(0)">Prev</a>
          </li>
          <li class="page-item" *ngFor="let page of [].constructor(totalPages); let i=index">
            <a class="page-link" [class.active]="currentPage===i+1" (click)="changePage(i+1)" href="javascript:void(0)">{{ i+1 }}</a>
          </li>
          <li class="page-item">
            <a class="page-link" [class.disabled]="currentPage===totalPages" (click)="changePage(currentPage+1)" href="javascript:void(0)">Next</a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Add/Edit Modal -->
<div *ngIf="showAddEditDialog" class="modal-backdrop d-flex justify-content-center align-items-center">
  <div class="modal-content p-3" style="max-height:90vh; overflow-y:auto;">
    <div class="modal-header">
      <h5>{{ isEditMode ? 'Edit Other Payment' : 'Add Other Payment' }}</h5>
      <button type="button" class="btn-close" (click)="closeDialog()"></button>
    </div>

    <div class="modal-body">
      <form [formGroup]="form">

        <!-- Student -->
        <label>Student</label>
        <select class="form-control mb-2" formControlName="studentId">
          <option *ngFor="let s of students" [value]="s.studentId">{{ s.studentName }}</option>
        </select>

<!-- Fees Multi-Select Dropdown -->
<label>Fees</label>
<div class="custom-dropdown mb-2">
  <div class="selected-items" (click)="toggleFeesDropdown()">
    {{ getSelectedFeesNames() }}
  </div>
  <div class="dropdown-options" *ngIf="showFeesDropdown">
    <div *ngFor="let f of fees" class="p-1">
      <label>
        <input type="checkbox" [checked]="isFeeSelected(f)" (change)="toggleFee(f, $event)" /> 
        {{ f.feeType?.typeName }} - {{ f.amount }}
      </label>
    </div>
  </div>
</div>

<!-- Academic Months Multi-Select Dropdown -->
<label>Academic Months</label>
<div class="custom-dropdown mb-2">
  <div class="selected-items" (click)="toggleMonthsDropdown()">
    {{ getSelectedMonthsNames() }}
  </div>
  <div class="dropdown-options" *ngIf="showMonthsDropdown">
    <div *ngFor="let m of academicMonths" class="p-1">
      <label>
        <input type="checkbox" [checked]="isMonthSelected(m)" (change)="toggleMonth(m, $event)" /> 
        {{ m.monthName }}
      </label>
    </div>
  </div>
</div>

        <!-- Waver and Amount Paid -->
        <label>Waver (%)</label>
        <input type="number" class="form-control mb-2" formControlName="waver" />

        <label>Amount Paid</label>
        <input type="number" class="form-control mb-2" formControlName="amountPaid" />

        <!-- Total & Due -->
        <label>Total Amount</label>
        <input type="number" class="form-control mb-2" formControlName="totalAmount"/>

        <label>Due Balance</label>
        <input type="number" class="form-control mb-2" formControlName="dueBalance" />

        <!-- Payment Date -->
        <label>Payment Date</label>
        <input type="date" class="form-control" formControlName="paymentDate" />
      </form>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeDialog()">Cancel</button>
      <button class="btn btn-primary" (click)="savePayment()" [disabled]="form.invalid">{{ isEditMode ? 'Update' : 'Save' }}</button>
    </div>
  </div>
</div>

<!-- View Modal -->
<div *ngIf="showViewDialog" class="modal-backdrop d-flex justify-content-center align-items-center">
  <div class="modal-content p-3" style="max-height:90vh; overflow-y:auto;">
    <div class="modal-header">
      <h5>Payment Details</h5>
      <button type="button" class="btn-close" (click)="closeDialog()"></button>
    </div>
    <div class="modal-body">
      <form [formGroup]="form">
        <!-- Student -->
        <label>Student</label>
        <input type="text" class="form-control mb-2" [value]="selectedPayment?.student?.studentName" readonly />

        <!-- Enrollment Number -->
        <label>Enrollment #</label>
        <input type="text" class="form-control mb-2" [value]="selectedPayment?.student?.enrollmentNo" readonly />


        <!-- Total & Paid & Remaining -->
        <label>Total Amount</label>
        <input type="number" class="form-control mb-2" [value]="selectedPayment?.totalAmount" readonly />

        <label>Amount Paid</label>
        <input type="number" class="form-control mb-2" [value]="selectedPayment?.amountPaid" readonly />

        <label>Amount Remaining</label>
        <input type="number" class="form-control mb-2" [value]="selectedPayment?.amountRemaining" readonly />

        <!-- Payment Date -->
        <label>Payment Date</label>
        <input type="date" class="form-control mb-2" [value]="selectedPayment?.paymentDate | date:'yyyy-MM-dd'" readonly />
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeDialog()">Close</button>
    </div>
  </div>
</div>



<!-- Delete Modal -->
<div *ngIf="showDeleteDialog" class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content radius-12 p-3">
      <div class="modal-header border-0">
        <h5 class="modal-title text-warning fw-semibold">Confirm Delete</h5>
        <button type="button" class="btn-close" (click)="showDeleteDialog=false"></button>
      </div>
      <div class="modal-body text-center">
        Are you sure you want to delete payment of "<strong>{{ paymentToDelete?.student?.studentName }}</strong>"?
      </div>
      <div class="modal-footer border-0 justify-content-center gap-2">
        <button type="button" class="btn btn-secondary px-4" (click)="showDeleteDialog=false">Cancel</button>
        <button type="button" class="btn btn-danger px-4" (click)="deletePayment()">Delete</button>
      </div>
    </div>
  </div>
</div>

<div class="dashboard-main-body">
  <app-breadcrumb [title]="title"></app-breadcrumb>

  <!-- Filters -->
  <div class="card radius-12 mb-24 overflow-hidden border-0 shadow-sm">
    <div class="card-header border-bottom bg-base py-16 px-24">
      <h6 class="text-md fw-semibold mb-0 text-primary-600">
        <iconify-icon icon="solar:filter-bold-duotone" class="me-2"></iconify-icon>
        Result Filters
      </h6>
    </div>
    <div class="card-body p-24">
      <div class="row gy-4">
        <div class="col-md-3">
          <label class="form-label fw-bold">Select Exam <span class="text-danger">*</span></label>
          <select class="form-select radius-8 h-45-px" [(ngModel)]="selectedExamId">
            <option [value]="0">Select Exam</option>
            <option *ngFor="let exam of exams" [value]="exam.examId">{{ exam.examName }}</option>
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label fw-bold">Select Class (Required)</label>
          <select class="form-select radius-8 h-45-px" [(ngModel)]="selectedClassId" (change)="onClassChange()">
            <option [value]="0">All Classes</option>
            <option *ngFor="let cls of classes" [value]="cls.standardId">{{ cls.standardName }}</option>
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label fw-bold">Select Section (Optional)</label>
          <select class="form-select radius-8 h-45-px" [(ngModel)]="selectedSectionId" (change)="onSectionChange()">
            <option [value]="0">All Sections</option>
            <option *ngFor="let sec of sections" [value]="sec.sectionId">{{ sec.sectionName }}</option>
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label fw-bold">Select Student <span class="text-danger">*</span></label>
          <select class="form-select radius-8 h-45-px" [(ngModel)]="selectedStudentId">
            <option [value]="0">Select Student</option>
            <option *ngFor="let student of filteredStudents" [value]="student.studentId">
              {{ student.admissionNo }} - {{ student.studentName }}
            </option>
          </select>
          <small class="text-secondary" *ngIf="selectedClassId > 0 && filteredStudents.length === 0">No students found
            in this class.</small>
        </div>

        <div class="col-12 text-end">
          <button class="btn btn-primary radius-8 px-32 h-45-px d-inline-flex align-items-center gap-2"
            (click)="loadResults()" [disabled]="!selectedExamId || !selectedStudentId">
            <iconify-icon icon="solar:magnifer-bold-duotone" class="text-xl"></iconify-icon>
            View Result
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div *ngIf="examResults.length > 0 && !loading" class="card radius-12 mb-24 border-0 shadow-sm overflow-hidden">
    <div class="card-body p-16 px-24 bg-neutral-50 d-flex align-items-center justify-content-between flex-wrap gap-3">
      <div class="d-flex align-items-center gap-2">
        <div
          class="w-40-px h-40-px radius-8 bg-primary-100 text-primary-600 d-flex justify-content-center align-items-center">
          <iconify-icon icon="solar:printer-bold-duotone" class="text-xl"></iconify-icon>
        </div>
        <h6 class="mb-0 text-primary-600">Export Options</h6>
      </div>
      <div class="d-flex align-items-center gap-3">
        <button type="button" (click)="printResult()"
          class="btn btn-primary-600 radius-8 px-24 py-11 d-flex align-items-center gap-2 shadow-sm">
          <iconify-icon icon="solar:printer-bold-duotone" class="text-xl"></iconify-icon>
          Print Result
        </button>
        <button type="button" (click)="printResult()"
          class="btn btn-success-600 radius-8 px-24 py-11 d-flex align-items-center gap-2 shadow-sm">
          <iconify-icon icon="solar:file-download-bold-duotone" class="text-xl"></iconify-icon>
          Download PDF
        </button>
      </div>
    </div>
  </div>

  <!-- Loading & Empty States -->
  <div *ngIf="loading" class="card radius-12 shadow-sm border-0">
    <div class="card-body p-40 text-center">
      <div class="spinner-border text-primary mb-3" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="text-secondary-light fw-medium">Analyzing student performance...</p>
    </div>
  </div>

  <div *ngIf="!loading && examResults.length === 0" class="card radius-12 shadow-sm border-0">
    <div class="card-body p-80 text-center">
      <iconify-icon icon="solar:document-text-bold-duotone" class="text-neutral-300 display-1 mb-24"></iconify-icon>
      <h5 class="text-neutral-900 mb-8">No Result Loaded</h5>
      <p class="text-secondary-light mx-auto" style="max-width: 400px;">Please use the filters above to select an exam
        and a student to view their detailed performance report.</p>
    </div>
  </div>

  <!-- Results Component -->
  <div *ngIf="!loading && examResults.length > 0">
    <!-- Summary Stats -->
    <div class="row gy-4 mb-24">
      <div class="col-xxl-3 col-sm-6">
        <div class="card radius-12 border-0 shadow-sm h-100 bg-base">
          <div class="card-body p-24">
            <div class="d-flex align-items-center gap-3">
              <div
                class="w-56-px h-56-px radius-12 d-flex justify-content-center align-items-center bg-primary-100 text-primary-600">
                <iconify-icon icon="solar:chart-square-bold-duotone" class="text-3xl"></iconify-icon>
              </div>
              <div>
                <h4 class="fw-bold mb-1 text-neutral-900">{{ totalMarks }}</h4>
                <p class="text-sm text-secondary-light fw-medium mb-0">Max Marks</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-xxl-3 col-sm-6">
        <div class="card radius-12 border-0 shadow-sm h-100 bg-base">
          <div class="card-body p-24">
            <div class="d-flex align-items-center gap-3">
              <div
                class="w-56-px h-56-px radius-12 d-flex justify-content-center align-items-center bg-success-100 text-success-600">
                <iconify-icon icon="solar:ranking-bold-duotone" class="text-3xl"></iconify-icon>
              </div>
              <div>
                <h4 class="fw-bold mb-1 text-neutral-900">{{ obtainedMarks }}</h4>
                <p class="text-sm text-secondary-light fw-medium mb-0">Marks Scored</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-xxl-3 col-sm-6">
        <div class="card radius-12 border-0 shadow-sm h-100 bg-base">
          <div class="card-body p-24">
            <div class="d-flex align-items-center gap-3">
              <div
                class="w-56-px h-56-px radius-12 d-flex justify-content-center align-items-center bg-info-100 text-info-600">
                <iconify-icon icon="solar:pie-chart-bold-duotone" class="text-3xl"></iconify-icon>
              </div>
              <div>
                <h4 class="fw-bold mb-1 text-neutral-900">{{ percentage | number:'1.1-1' }}%</h4>
                <p class="text-sm text-secondary-light fw-medium mb-0">Avg Percentage</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-xxl-3 col-sm-6">
        <div class="card radius-12 border-0 shadow-sm h-100 bg-base">
          <div class="card-body p-24">
            <div class="d-flex align-items-center gap-3">
              <div class="w-56-px h-56-px radius-12 d-flex justify-content-center align-items-center"
                [ngClass]="resultStatus === 'PASS' ? 'bg-success-100 text-success-600' : 'bg-danger-100 text-danger-600'">
                <iconify-icon
                  [icon]="resultStatus === 'PASS' ? 'solar:medal-star-bold-duotone' : 'solar:danger-bold-duotone'"
                  class="text-3xl"></iconify-icon>
              </div>
              <div>
                <h6 class="mb-1">
                  <span class="badge px-16 py-6 radius-8 text-md"
                    [ngClass]="resultStatus === 'PASS' ? 'bg-success-100 text-success-600' : 'bg-danger-100 text-danger-600'">
                    {{ resultStatus }}
                  </span>
                </h6>
                <p class="text-sm text-secondary-light fw-medium mb-0">Final Status</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Details Table -->
    <div class="card radius-12 shadow-sm border-0 overflow-hidden">
      <div class="card-header border-bottom bg-base py-16 px-24 d-flex align-items-center justify-content-between">
        <h6 class="text-md fw-bold mb-0">Detailed Subject Report</h6>
        <span class="badge bg-primary-100 text-primary-600 px-16 py-8 radius-8">Academic Results 2025</span>
      </div>

      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table mb-0 border-0">
            <thead class="bg-neutral-50">
              <tr>
                <th class="ps-24 py-16">Subject Name</th>
                <th class="text-center py-16">Total Marks</th>
                <th class="text-center py-16">Obtained</th>
                <th class="text-center py-16">Percentage</th>
                <th class="text-center py-16">Grade</th>
                <th class="pe-24 text-center py-16">Status</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let result of displayResults; let i = index">
                <td class="ps-24">
                  <div class="d-flex align-items-center">
                    <div class="w-10-px h-10-px rounded-circle bg-primary-600 me-12"></div>
                    <span class="fw-bold text-neutral-800">{{ result.subjectName }}</span>
                  </div>
                </td>
                <td class="text-center fw-medium">{{ result.totalMarks }}</td>
                <td class="text-center fw-bold text-primary-600">{{ result.obtainedMarks }}</td>
                <td class="text-center fw-medium">
                  <div class="d-flex align-items-center justify-content-center gap-2">
                    <div class="progress w-60-px h-6-px bg-neutral-100 radius-12">
                      <div class="progress-bar" [style.width.%]="result.percentage"
                        [ngClass]="result.isPassed ? 'bg-success-600' : 'bg-danger-600'"></div>
                    </div>
                    <span class="text-xs">{{ result.percentage }}%</span>
                  </div>
                </td>
                <td class="text-center">
                  <span class="badge radius-4 px-12 py-6 text-sm" [ngClass]="getGradeBadgeClass(result.grade)">
                    {{ result.grade }}
                  </span>
                </td>
                <td class="pe-24 text-center">
                  <span class="badge radius-20 px-12 py-6 text-xs d-inline-flex align-items-center gap-1"
                    [ngClass]="result.isPassed ? 'bg-success-50 text-success-600 border border-success-200' : 'bg-danger-50 text-danger-600 border border-danger-200'">
                    <iconify-icon
                      [icon]="result.isPassed ? 'solar:check-circle-bold-duotone' : 'solar:close-circle-bold-duotone'"></iconify-icon>
                    {{ result.isPassed ? 'Passed' : 'Failed' }}
                  </span>
                </td>
              </tr>
            </tbody>
            <tfoot class="bg-primary-50">
              <tr class="fw-bold">
                <td class="ps-24 py-20 text-primary-600 uppercase ls-1">Aggregate Result</td>
                <td class="text-center py-20">{{ totalMarks }}</td>
                <td class="text-center py-20 text-primary-700 fs-5">{{ obtainedMarks }}</td>
                <td class="text-center py-20">{{ percentage | number:'1.2-2' }}%</td>
                <td class="text-center py-20">
                  <span class="badge bg-primary-600 text-white radius-8 px-16 py-8 shadow-sm">{{ overallGrade }}</span>
                </td>
                <td class="pe-24 text-center py-20">
                  <span class="badge radius-8 px-20 py-10"
                    [ngClass]="resultStatus === 'PASS' ? 'bg-success-600 text-white' : 'bg-danger-600 text-white'">
                    {{ resultStatus }}
                  </span>
                </td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
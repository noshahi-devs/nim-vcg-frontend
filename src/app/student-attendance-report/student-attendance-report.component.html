<div class="dashboard-main-body">
  <app-breadcrumb [title]="title"></app-breadcrumb>

  <!-- Filters Card -->
  <div class="card radius-12 mb-4">
    <div class="card-header bg-base py-16 px-24 border-bottom">
      <h6 class="fw-semibold mb-0">Report Filters</h6>
    </div>
    <div class="card-body p-24">
      <div class="row g-3">
        <!-- Date Range Dropdown with Calendar -->
        <div class="col-md-12">
          <label class="form-label fw-semibold">Select Date Range</label>
          <div class="dropdown">
            <button 
              class="btn btn-outline-primary d-flex align-items-center justify-content-between px-3 py-2 radius-8" 
              type="button" 
              id="dateRangeDropdown" 
              data-bs-toggle="dropdown" 
              aria-expanded="false"
              style="min-width: 300px;">
              <span>
                <iconify-icon icon="mdi:calendar-range" class="me-2"></iconify-icon>
                <span *ngIf="selectedRange === 'today'">Today - {{ selectedDate }}</span>
                <span *ngIf="selectedRange === 'yesterday'">Yesterday - {{ selectedDate }}</span>
                <span *ngIf="selectedRange === 'week'">Last 7 Days ({{ customStartDate }} to {{ customEndDate }})</span>
                <span *ngIf="selectedRange === 'month'">Last Month ({{ customStartDate }} to {{ customEndDate }})</span>
                <span *ngIf="selectedRange === 'last30'">Last 30 Days ({{ customStartDate }} to {{ customEndDate }})</span>
                <span *ngIf="selectedRange === 'custom'">Custom Range ({{ customStartDate }} to {{ customEndDate }})</span>
              </span>
              <iconify-icon icon="mdi:chevron-down"></iconify-icon>
            </button>
            <div class="dropdown-menu p-0 shadow-lg" aria-labelledby="dateRangeDropdown" style="min-width: 550px; max-width: 550px;">
              <div class="row g-0">
                <!-- Quick Options -->
                <div class="col-5 bg-light border-end">
                  <div class="p-3">
                    <h6 class="fw-semibold mb-3 text-secondary">Quick Select</h6>
                    <div class="d-flex flex-column gap-1">
                      <a 
                        href="javascript:void(0)"
                        class="date-range-option px-3 py-2 rounded text-decoration-none d-flex align-items-center"
                        [class.active]="selectedRange === 'today'"
                        (click)="selectedRange = 'today'; onRangeChange()">
                        <iconify-icon icon="mdi:calendar-today" class="me-2"></iconify-icon>
                        <span>Today</span>
                      </a>
                      <a 
                        href="javascript:void(0)"
                        class="date-range-option px-3 py-2 rounded text-decoration-none d-flex align-items-center"
                        [class.active]="selectedRange === 'yesterday'"
                        (click)="selectedRange = 'yesterday'; onRangeChange()">
                        <iconify-icon icon="mdi:calendar-minus" class="me-2"></iconify-icon>
                        <span>Yesterday</span>
                      </a>
                      <a 
                        href="javascript:void(0)"
                        class="date-range-option px-3 py-2 rounded text-decoration-none d-flex align-items-center"
                        [class.active]="selectedRange === 'week'"
                        (click)="selectedRange = 'week'; onRangeChange()">
                        <iconify-icon icon="mdi:calendar-week" class="me-2"></iconify-icon>
                        <span>Last 7 Days</span>
                      </a>
                      <a 
                        href="javascript:void(0)"
                        class="date-range-option px-3 py-2 rounded text-decoration-none d-flex align-items-center"
                        [class.active]="selectedRange === 'month'"
                        (click)="selectedRange = 'month'; onRangeChange()">
                        <iconify-icon icon="mdi:calendar-month" class="me-2"></iconify-icon>
                        <span>Last Month</span>
                      </a>
                      <a 
                        href="javascript:void(0)"
                        class="date-range-option px-3 py-2 rounded text-decoration-none d-flex align-items-center"
                        [class.active]="selectedRange === 'last30'"
                        (click)="selectedRange = 'last30'; onRangeChange()">
                        <iconify-icon icon="mdi:calendar-range" class="me-2"></iconify-icon>
                        <span>Last 30 Days</span>
                      </a>
                      <hr class="my-2">
                      <a 
                        href="javascript:void(0)"
                        class="date-range-option px-3 py-2 rounded text-decoration-none d-flex align-items-center"
                        [class.active]="selectedRange === 'custom'"
                        (click)="selectedRange = 'custom'">
                        <iconify-icon icon="mdi:calendar-edit" class="me-2"></iconify-icon>
                        <span>Custom Range</span>
                      </a>
                    </div>
                  </div>
                </div>

                <!-- Calendar Section -->
                <div class="col-7">
                  <div class="p-3">
                    <!-- Calendar Header -->
                    <div class="d-flex align-items-center justify-content-between mb-3">
                      <button 
                        type="button" 
                        class="btn btn-sm btn-outline-secondary radius-8"
                        (click)="previousMonth()">
                        <iconify-icon icon="mdi:chevron-left"></iconify-icon>
                      </button>
                      <h6 class="fw-semibold mb-0 text-secondary">
                        {{ monthNames[currentMonth.getMonth()] }} {{ currentMonth.getFullYear() }}
                      </h6>
                      <button 
                        type="button" 
                        class="btn btn-sm btn-outline-secondary radius-8"
                        (click)="nextMonth()">
                        <iconify-icon icon="mdi:chevron-right"></iconify-icon>
                      </button>
                    </div>

                    <!-- Calendar Grid -->
                    <div class="calendar-grid mb-3">
                      <!-- Day Headers -->
                      <div class="calendar-day-header">Su</div>
                      <div class="calendar-day-header">Mo</div>
                      <div class="calendar-day-header">Tu</div>
                      <div class="calendar-day-header">We</div>
                      <div class="calendar-day-header">Th</div>
                      <div class="calendar-day-header">Fr</div>
                      <div class="calendar-day-header">Sa</div>

                      <!-- Calendar Days -->
                      <div 
                        *ngFor="let dayObj of calendarDays"
                        class="calendar-day"
                        [class.empty]="!dayObj.day"
                        [class.today]="isToday(dayObj.date)"
                        [class.selected]="isDateSelected(dayObj.date)"
                        [class.in-range]="isDateInRange(dayObj.date)"
                        (click)="selectDate(dayObj.date)">
                        {{ dayObj.day }}
                      </div>
                    </div>

                    <!-- Selected Date Info -->
                    <div class="mb-3 p-2 bg-light rounded text-sm" *ngIf="tempStartDate">
                      <div *ngIf="selectedRange === 'today' || selectedRange === 'yesterday'">
                        <strong>Selected:</strong> {{ formatDate(tempStartDate) }}
                      </div>
                      <div *ngIf="selectedRange !== 'today' && selectedRange !== 'yesterday'">
                        <strong>From:</strong> {{ formatDate(tempStartDate) }}
                        <span *ngIf="tempEndDate"> <strong>To:</strong> {{ formatDate(tempEndDate) }}</span>
                        <span *ngIf="!tempEndDate" class="text-muted"> (Select end date)</span>
                      </div>
                    </div>

                    <!-- Apply/Cancel Buttons -->
                    <div class="d-flex gap-2 pt-2 border-top">
                      <button 
                        type="button" 
                        class="btn btn-sm btn-primary flex-fill radius-8"
                        [disabled]="!canApply"
                        data-bs-toggle="dropdown"
                        (click)="applyDateRange()">
                        <iconify-icon icon="mdi:check" class="me-1"></iconify-icon>
                        Apply
                      </button>
                      <button 
                        type="button" 
                        class="btn btn-sm btn-outline-secondary flex-fill radius-8"
                        data-bs-toggle="dropdown">
                        <iconify-icon icon="mdi:close" class="me-1"></iconify-icon>
                        Cancel
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Class & Section in One Row -->
        <div class="col-md-6">
          <label class="form-label fw-semibold">Class (Optional)</label>
          <select class="form-select radius-8" [(ngModel)]="selectedClass">
            <option value="">All Classes</option>
            <option *ngFor="let cls of classes" [value]="cls">Class {{ cls }}</option>
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label fw-semibold">Section (Optional)</label>
          <select class="form-select radius-8" [(ngModel)]="selectedSection">
            <option value="">All Sections</option>
            <option *ngFor="let sec of sections" [value]="sec">Section {{ sec }}</option>
          </select>
        </div>

        <!-- Load Button -->
        <div class="col-md-12">
          <button 
            type="button" 
            class="btn btn-primary px-4 py-2 radius-8"
            (click)="loadReport()">
            <iconify-icon icon="mdi:file-document" class="me-2"></iconify-icon>
            Load Report
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Stats Summary -->
  <div class="row g-3 mb-4" *ngIf="reportLoaded">
    <div class="col-md-3">
      <div class="card radius-12 h-100">
        <div class="card-body p-24">
          <div class="d-flex align-items-center gap-3">
            <div class="w-64-px h-64-px radius-12 bg-primary-50 d-flex align-items-center justify-content-center">
              <iconify-icon icon="mdi:account-group" class="text-primary-600" style="font-size: 32px;"></iconify-icon>
            </div>
            <div>
              <h6 class="fw-bold mb-1">{{ attendanceStats.total }}</h6>
              <small class="text-secondary-light">Total Records</small>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card radius-12 h-100">
        <div class="card-body p-24">
          <div class="d-flex align-items-center gap-3">
            <div class="w-64-px h-64-px radius-12 bg-success-50 d-flex align-items-center justify-content-center">
              <iconify-icon icon="mdi:check-circle" class="text-success-600" style="font-size: 32px;"></iconify-icon>
            </div>
            <div>
              <h6 class="fw-bold mb-1 text-success-600">{{ attendanceStats.present }}</h6>
              <small class="text-secondary-light">Present</small>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card radius-12 h-100">
        <div class="card-body p-24">
          <div class="d-flex align-items-center gap-3">
            <div class="w-64-px h-64-px radius-12 bg-danger-50 d-flex align-items-center justify-content-center">
              <iconify-icon icon="mdi:close-circle" class="text-danger-600" style="font-size: 32px;"></iconify-icon>
            </div>
            <div>
              <h6 class="fw-bold mb-1 text-danger-600">{{ attendanceStats.absent }}</h6>
              <small class="text-secondary-light">Absent</small>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card radius-12 h-100">
        <div class="card-body p-24">
          <div class="d-flex align-items-center gap-3">
            <div class="w-64-px h-64-px radius-12 bg-warning-50 d-flex align-items-center justify-content-center">
              <iconify-icon icon="mdi:alert-circle" class="text-warning-600" style="font-size: 32px;"></iconify-icon>
            </div>
            <div>
              <h6 class="fw-bold mb-1 text-warning-600">{{ attendanceStats.leave + attendanceStats.late }}</h6>
              <small class="text-secondary-light">Leave/Late</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Report Table -->
  <div class="card radius-12" *ngIf="reportLoaded">
    <!-- Toolbar -->
    <div class="card-header border-bottom bg-base py-16 px-24 d-flex align-items-center flex-wrap gap-3 justify-content-between">
      <div class="d-flex align-items-center flex-wrap gap-3">
        <span class="text-md fw-medium text-secondary-light mb-0">Show</span>
        <select class="form-select form-select-sm w-auto ps-12 py-6 radius-12 h-40-px" [(ngModel)]="itemsPerPage">
          <option [value]="10">10</option>
          <option [value]="25">25</option>
          <option [value]="50">50</option>
          <option [value]="100">100</option>
        </select>

        <!-- Search -->
        <form class="navbar-search">
          <input
            type="text"
            class="bg-base h-40-px w-auto"
            name="search"
            [(ngModel)]="searchQuery"
            placeholder="Search..."
          />
          <iconify-icon icon="ion:search-outline" class="icon"></iconify-icon>
        </form>
      </div>

      <!-- Export Buttons -->
      <div class="d-flex flex-wrap gap-2">
        <button 
          type="button" 
          class="btn btn-sm btn-outline-primary px-3 py-2 radius-8"
          (click)="copyToClipboard()"
          title="Copy to Clipboard">
          <iconify-icon icon="mdi:content-copy" class="me-1"></iconify-icon>
          Copy
        </button>
        <button 
          type="button" 
          class="btn btn-sm btn-outline-danger px-3 py-2 radius-8"
          (click)="exportToPDF()"
          title="Export to PDF">
          <iconify-icon icon="mdi:file-pdf" class="me-1"></iconify-icon>
          PDF
        </button>
        <button 
          type="button" 
          class="btn btn-sm btn-outline-success px-3 py-2 radius-8"
          (click)="downloadCSV()"
          title="Download CSV">
          <iconify-icon icon="mdi:file-excel" class="me-1"></iconify-icon>
          CSV
        </button>
        <button 
          type="button" 
          class="btn btn-sm btn-outline-secondary px-3 py-2 radius-8"
          (click)="printReport()"
          title="Print Report">
          <iconify-icon icon="mdi:printer" class="me-1"></iconify-icon>
          Print
        </button>
      </div>
    </div>

    <div class="card-body p-24">
      <div class="table-responsive">
        <table class="table bordered-table mb-0">
          <thead>
            <tr>
              <th>S.No</th>
              <th>Student Name</th>
              <th>Roll No</th>
              <th>Class</th>
              <th>Date</th>
              <th>Status</th>
              <th>Remarks</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let record of paginatedRecords">
              <td>{{ record.serialNo }}</td>
              <td>
                <span class="fw-semibold">{{ record.name }}</span>
              </td>
              <td>
                <span class="badge bg-neutral-200 text-neutral-900 px-2 py-1">{{ record.rollNo }}</span>
              </td>
              <td>{{ record.class }}-{{ record.section }}</td>
              <td>{{ record.date }}</td>
              <td>
                <span 
                  class="badge px-3 py-2 radius-8"
                  [class.bg-success-50]="record.status === 'Present'"
                  [class.text-success-600]="record.status === 'Present'"
                  [class.bg-danger-50]="record.status === 'Absent'"
                  [class.text-danger-600]="record.status === 'Absent'"
                  [class.bg-warning-50]="record.status === 'Leave'"
                  [class.text-warning-600]="record.status === 'Leave'"
                  [class.bg-info-50]="record.status === 'Late'"
                  [class.text-info-600]="record.status === 'Late'">
                  {{ record.status }}
                </span>
              </td>
              <td>
                <small class="text-secondary-light">{{ record.remarks || '-' }}</small>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mt-3">
        <span class="text-secondary-light text-sm">Showing {{ paginationStart }} to {{ paginationEnd }} of {{ filteredRecords.length }} entries</span>
        <ul class="pagination d-flex flex-wrap align-items-center gap-2 justify-content-center">
          <li class="page-item">
            <a 
              class="page-link bg-neutral-200 text-secondary-light fw-semibold radius-8 border-0 d-flex align-items-center justify-content-center h-32-px w-32-px text-md"
              [class.disabled]="currentPage === 1"
              (click)="changePage(currentPage - 1)"
              href="javascript:void(0)">
              <iconify-icon icon="ep:d-arrow-left" class=""></iconify-icon>
            </a>
          </li>
          <li class="page-item" *ngFor="let page of totalPagesArray">
            <a 
              class="page-link fw-semibold radius-8 border-0 d-flex align-items-center justify-content-center h-32-px w-32-px text-md"
              [class.bg-primary-600]="currentPage === page"
              [class.text-white]="currentPage === page"
              [class.bg-neutral-200]="currentPage !== page"
              [class.text-secondary-light]="currentPage !== page"
              (click)="changePage(page)"
              href="javascript:void(0)">
              {{ page }}
            </a>
          </li>
          <li class="page-item">
            <a 
              class="page-link bg-neutral-200 text-secondary-light fw-semibold radius-8 border-0 d-flex align-items-center justify-content-center h-32-px w-32-px text-md"
              [class.disabled]="currentPage === totalPages"
              (click)="changePage(currentPage + 1)"
              href="javascript:void(0)">
              <iconify-icon icon="ep:d-arrow-right" class=""></iconify-icon>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div class="card radius-12" *ngIf="!reportLoaded">
    <div class="card-body p-5 text-center">
      <iconify-icon icon="mdi:file-document-outline" style="font-size: 64px;" class="text-secondary-light mb-3"></iconify-icon>
      <h5 class="mb-2">No Report Loaded</h5>
      <p class="text-secondary-light">Please select date range and filters, then click "Load Report" to view attendance data.</p>
    </div>
  </div>
</div>
